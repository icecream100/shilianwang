<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视联网适配中心 - 系统设置</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .nav-item {
            padding: 12px 20px;
            color: #bdc3c7;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .nav-item.active {
            background-color: rgba(64, 158, 255, 0.2);
            color: #409eff;
            border-left-color: #409eff;
        }
        .nav-group {
            margin-bottom: 10px;
        }
        .nav-group-title {
            padding: 8px 20px;
            color: #95a5a6;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .nav-submenu {
            padding-left: 40px;
            font-size: 14px;
        }
        .content-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        .status-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-enabled {
            background-color: #f0f9ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .status-disabled {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .tab-content {
            min-height: 600px;
        }
        .permission-tree {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
        }
        .role-checkbox {
            width: 100%;
            margin-right: 0 !important;
            padding: 8px 0;
        }
        .role-checkbox .el-checkbox__label {
            width: 100%;
            padding-left: 8px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="flex h-screen bg-gray-50">
            <!-- 左侧导航 -->
            <div class="w-64 sidebar">
                <div class="p-6 border-b border-gray-600">
                    <h1 class="text-xl font-bold text-white">视联网适配中心</h1>
                </div>
                <nav class="mt-6">
                    <div class="nav-group">
                        <div class="nav-group-title">运营门户</div>
                        <div class="nav-item">
                            <i class="el-icon-monitor"></i> 驾驶舱
                        </div>
                        <div class="nav-item">
                            <i class="el-icon-user"></i> 客户管理
                        </div>
                        <div class="nav-item" :class="{active: activeMenu === 'analysis'}" @click="activeMenu = 'analysis'">
                            <i class="el-icon-data-analysis"></i> 运营分析
                        </div>
                        <!-- 运营分析二级菜单 -->
                        <div v-if="activeMenu === 'analysis'" class="nav-submenu">
                            <div class="nav-item">
                                <i class="el-icon-user"></i> 客户分析
                            </div>
                            <div class="nav-item">
                                <i class="el-icon-cpu"></i> 设备分析
                            </div>
                            <div class="nav-item">
                                <i class="el-icon-data-line"></i> 业务分析
                            </div>
                        </div>

                        <div class="nav-item" :class="{active: activeMenu === 'system'}" @click="activeMenu = 'system'">
                            <i class="el-icon-setting"></i> 系统配置
                        </div>
                        <!-- 系统配置二级菜单 -->
                        <div v-if="activeMenu === 'system'" class="nav-submenu">
                            <div class="nav-item" :class="{active: activeTab === 'users'}" @click="activeTab = 'users'">
                                <i class="el-icon-user"></i> 用户管理
                            </div>
                            <div class="nav-item" :class="{active: activeTab === 'roles'}" @click="activeTab = 'roles'">
                                <i class="el-icon-s-custom"></i> 角色管理
                            </div>
                            <div class="nav-item" :class="{active: activeTab === 'depts'}" @click="activeTab = 'depts'">
                                <i class="el-icon-office-building"></i> 部门管理
                            </div>
                        </div>
                        <div class="nav-item" :class="{active: activeMenu === 'logs'}" @click="activeMenu = 'logs'">
                            <i class="el-icon-document"></i> 日志管理
                        </div>
                        <!-- 日志管理二级菜单 -->
                        <div v-if="activeMenu === 'logs'" class="nav-submenu">
                            <div class="nav-item">
                                <i class="el-icon-key"></i> 登录日志
                            </div>
                            <div class="nav-item">
                                <i class="el-icon-edit"></i> 操作日志
                            </div>
                        </div>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">接口适配</div>
                        <div class="nav-item" :class="{active: activeMenu === 'interface'}" @click="activeMenu = 'interface'">
                            <i class="el-icon-connection"></i> 接入平台管理
                        </div>
                        <div class="nav-item" :class="{active: activeMenu === 'device'}" @click="activeMenu = 'device'">
                            <i class="el-icon-cpu"></i> 设备管理
                        </div>
                        <div class="nav-item" :class="{active: activeMenu === 'channel'}" @click="activeMenu = 'channel'">
                            <i class="el-icon-link"></i> 通道管理
                        </div>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">业务数据采集</div>
                        <div class="nav-item" :class="{active: activeMenu === 'collection'}" @click="activeMenu = 'collection'">
                            <i class="el-icon-data-board"></i> 业务采集设置
                        </div>
                        <div class="nav-item" :class="{active: activeMenu === 'sync'}" @click="activeMenu = 'sync'">
                            <i class="el-icon-refresh"></i> 客户同步设置
                        </div>
                        <div class="nav-item" :class="{active: activeMenu === 'task'}" @click="activeMenu = 'task'">
                            <i class="el-icon-view"></i> 任务状态
                        </div>
                    </div>
                </nav>
            </div>

            <!-- 主内容区域 -->
            <div class="flex-1 overflow-auto">
                <!-- 顶部标题栏 -->
                <div class="bg-white shadow-sm border-b px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">系统设置</h2>
                        </div>
                        <div class="flex items-center space-x-4">
                            <!-- 用户信息 -->
                            <div class="flex items-center space-x-3 ml-6 pl-6 border-l border-gray-200">
                                <el-dropdown trigger="click" @command="handleUserCommand">
                                    <div class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 px-3 py-2 rounded-lg transition-colors">
                                        <el-avatar :size="32" :src="userInfo.avatarUrl" class="border border-gray-200">
                                            <el-icon><User /></el-icon>
                                        </el-avatar>
                                        <div class="text-left">
                                            <div class="text-sm font-medium text-gray-800">{{userInfo.realName}}</div>
                                            <div class="text-xs text-gray-500">{{userInfo.department}}</div>
                                        </div>
                                        <el-icon class="text-gray-400"><ArrowDown /></el-icon>
                                    </div>
                                    <template #dropdown>
                                        <el-dropdown-menu>
                                            <el-dropdown-item command="profile">
                                                <el-icon><User /></el-icon>
                                                个人中心
                                            </el-dropdown-item>
                                            <el-dropdown-item command="password">
                                                <el-icon><Lock /></el-icon>
                                                修改密码
                                            </el-dropdown-item>
                                            <el-dropdown-item command="logout" divided>
                                                <el-icon><SwitchButton /></el-icon>
                                                退出登录
                                            </el-dropdown-item>
                                        </el-dropdown-menu>
                                    </template>
                                </el-dropdown>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统设置内容 -->
                <div class="p-6">
                    <!-- 用户管理 -->
                    <div v-if="activeTab === 'users'" class="content-card">
                        <div class="tab-content p-6">
                            <div class="mb-4">
                                <h3 class="text-xl font-bold text-gray-800">用户管理</h3>
                                <p class="text-gray-600 mt-1">管理系统用户账户信息</p>
                            </div>
                                <!-- 筛选区域 -->
                                <div class="mb-6">
                                    <el-form :inline="true" :model="userFilters" class="demo-form-inline">
                                        <el-form-item label="用户名">
                                            <el-input v-model="userFilters.username" placeholder="请输入用户名" clearable style="width: 200px"></el-input>
                                        </el-form-item>
                                        <el-form-item label="姓名">
                                            <el-input v-model="userFilters.realName" placeholder="请输入姓名" clearable style="width: 200px"></el-input>
                                        </el-form-item>
                                        <el-form-item label="手机号">
                                            <el-input v-model="userFilters.phoneNumber" placeholder="请输入手机号" clearable style="width: 200px"></el-input>
                                        </el-form-item>
                                        <el-form-item label="状态">
                                            <el-select v-model="userFilters.status" placeholder="请选择状态" clearable style="width: 120px">
                                                <el-option label="全部" value=""></el-option>
                                                <el-option label="启用" value="1"></el-option>
                                                <el-option label="禁用" value="0"></el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item>
                                            <el-button type="primary" @click="searchUsers">查询</el-button>
                                            <el-button @click="resetUserFilters">重置</el-button>
                                        </el-form-item>
                                    </el-form>
                                    
                                    <!-- 分隔线和操作按钮区 -->
                                    <div class="border-t border-gray-200 pt-4 mt-4">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <el-button type="primary" @click="showAddUserDialog">新增用户</el-button>
                                            </div>
                                            <div class="text-sm text-gray-500">
                                                共 {{ userPagination.total }} 条记录
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 用户列表 -->
                                <el-table :data="filteredUsers" style="width: 100%" v-loading="userLoading">
                                    <el-table-column type="index" label="序号" width="60"></el-table-column>
                                    <el-table-column prop="username" label="用户名" width="120"></el-table-column>
                                    <el-table-column prop="realName" label="姓名" width="100"></el-table-column>
                                    <el-table-column prop="phoneNumber" label="手机号" width="130"></el-table-column>
                                    <el-table-column prop="email" label="邮箱" width="180"></el-table-column>
                                    <el-table-column prop="department" label="所属部门" width="120"></el-table-column>
                                    <el-table-column label="角色" width="150">
                                        <template #default="scope">
                                            <el-tag v-for="role in scope.row.roles" :key="role" size="small" class="mr-1">{{ role }}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="状态" width="80">
                                        <template #default="scope">
                                            <span :class="scope.row.status === 1 ? 'status-tag status-enabled' : 'status-tag status-disabled'">
                                                {{ scope.row.status === 1 ? '启用' : '禁用' }}
                                            </span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="createTime" label="创建时间" width="160"></el-table-column>
                                    <el-table-column label="操作" width="280">
                                        <template #default="scope">
                                            <el-button size="small" @click="editUser(scope.row)">编辑</el-button>
                                            <el-button size="small" @click="assignRoles(scope.row)">分配角色</el-button>
                                            <el-button size="small" :type="scope.row.status === 1 ? 'warning' : 'success'" @click="toggleUserStatus(scope.row)">
                                                {{ scope.row.status === 1 ? '禁用' : '启用' }}
                                            </el-button>
                                            <el-button size="small" type="danger" @click="deleteUser(scope.row)">删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>

                                <!-- 分页 -->
                                <div class="mt-4 flex justify-end">
                                    <el-pagination
                                        v-model:current-page="userPagination.currentPage"
                                        v-model:page-size="userPagination.pageSize"
                                        :page-sizes="[10, 20, 50, 100]"
                                        :total="userPagination.total"
                                        layout="total, sizes, prev, pager, next, jumper">
                                    </el-pagination>
                                </div>
                        </div>
                    </div>

                    <!-- 部门管理 -->
                    <div v-if="activeTab === 'depts'" class="content-card">
                        <div class="tab-content p-6">
                            <div class="mb-4">
                                <h3 class="text-xl font-bold text-gray-800">部门管理</h3>
                                <p class="text-gray-600 mt-1">管理组织架构和部门信息</p>
                            </div>
                            <!-- 筛选区域 -->
                            <div class="mb-6">
                                <el-form :inline="true" :model="deptFilters" class="demo-form-inline">
                                    <el-form-item label="部门名称">
                                        <el-input v-model="deptFilters.deptName" placeholder="请输入部门名称" clearable style="width: 200px"></el-input>
                                    </el-form-item>
                                    <el-form-item label="状态">
                                        <el-select v-model="deptFilters.status" placeholder="请选择状态" clearable style="width: 120px">
                                            <el-option label="启用" :value="1"></el-option>
                                            <el-option label="禁用" :value="0"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="primary" @click="searchDepts">查询</el-button>
                                        <el-button @click="resetDeptFilters">重置</el-button>
                                    </el-form-item>
                                </el-form>
                                
                                <!-- 分隔线和操作按钮区 -->
                                <div class="border-t border-gray-200 pt-4 mt-4">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <el-button type="primary" @click="showAddDeptDialog">新增部门</el-button>
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            共 {{ deptPagination.total }} 条记录
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 部门树表格 -->
                            <el-table 
                                :data="filteredDepts" 
                                v-loading="deptLoading" 
                                row-key="id" 
                                :tree-props="{children: 'children', hasChildren: 'hasChildren'}"
                                :default-expand-all="false"
                                :expand-row-keys="[]"
                                ref="deptTableRef"
                                style="width: 100%">
                                <el-table-column prop="deptName" label="部门名称" min-width="200">
                                    <template #default="scope">
                                        <i class="el-icon-office-building" style="margin-right: 5px; color: #409EFF;"></i>
                                        {{ scope.row.deptName }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="orderNum" label="排序" width="80" align="center"></el-table-column>
                                <el-table-column prop="leader" label="负责人" width="120" align="center"></el-table-column>
                                <el-table-column prop="phone" label="联系电话" width="150" align="center"></el-table-column>
                                <el-table-column prop="email" label="邮箱" width="180" align="center"></el-table-column>
                                <el-table-column label="状态" width="80" align="center">
                                    <template #default="scope">
                                        <span :class="scope.row.status === 1 ? 'status-tag status-enabled' : 'status-tag status-disabled'">
                                            {{ scope.row.status === 1 ? '启用' : '禁用' }}
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="createTime" label="创建时间" width="180" align="center"></el-table-column>
                                <el-table-column label="操作" width="240" align="center">
                                    <template #default="scope">
                                        <el-button size="small" @click="editDept(scope.row)">编辑</el-button>
                                        <el-button size="small" :type="scope.row.status === 1 ? 'warning' : 'success'" @click="toggleDeptStatus(scope.row)">
                                            {{ scope.row.status === 1 ? '禁用' : '启用' }}
                                        </el-button>
                                        <el-button size="small" type="danger" @click="deleteDept(scope.row)" :disabled="scope.row.children && scope.row.children.length > 0">
                                            删除
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>

                    <!-- 角色管理 -->
                    <div v-if="activeTab === 'roles'" class="content-card">
                        <div class="tab-content p-6">
                            <div class="mb-4">
                                <h3 class="text-xl font-bold text-gray-800">角色管理</h3>
                                <p class="text-gray-600 mt-1">管理系统角色和权限配置</p>
                            </div>
                                <!-- 筛选区域 -->
                                <div class="mb-6">
                                    <el-form :inline="true" :model="roleFilters" class="demo-form-inline">
                                        <el-form-item label="角色名称">
                                            <el-input v-model="roleFilters.roleName" placeholder="请输入角色名称" clearable style="width: 200px"></el-input>
                                        </el-form-item>
                                        <el-form-item>
                                            <el-button type="primary" @click="searchRoles">查询</el-button>
                                            <el-button @click="resetRoleFilters">重置</el-button>
                                        </el-form-item>
                                    </el-form>
                                    
                                    <!-- 分隔线和操作按钮区 -->
                                    <div class="border-t border-gray-200 pt-4 mt-4">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <el-button type="primary" @click="showAddRoleDialog">新增角色</el-button>
                                            </div>
                                            <div class="text-sm text-gray-500">
                                                共 {{ rolePagination.total }} 条记录
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 角色列表 -->
                                <el-table :data="filteredRoles" style="width: 100%" v-loading="roleLoading">
                                    <el-table-column type="index" label="序号" width="60"></el-table-column>
                                    <el-table-column prop="roleName" label="角色名称" width="150"></el-table-column>
                                    <el-table-column prop="roleKey" label="角色标识" width="150"></el-table-column>
                                    <el-table-column prop="description" label="角色描述" min-width="200"></el-table-column>
                                    <el-table-column label="状态" width="80">
                                        <template #default="scope">
                                            <span :class="scope.row.status === 1 ? 'status-tag status-enabled' : 'status-tag status-disabled'">
                                                {{ scope.row.status === 1 ? '启用' : '禁用' }}
                                            </span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="createTime" label="创建时间" width="160"></el-table-column>
                                    <el-table-column label="操作" width="280">
                                        <template #default="scope">
                                            <el-button size="small" @click="editRole(scope.row)">编辑</el-button>
                                            <el-button size="small" type="primary" @click="assignPermissions(scope.row)">授权</el-button>
                                            <el-button size="small" :type="scope.row.status === 1 ? 'warning' : 'success'" @click="toggleRoleStatus(scope.row)">
                                                {{ scope.row.status === 1 ? '禁用' : '启用' }}
                                            </el-button>
                                            <el-button size="small" type="danger" @click="deleteRole(scope.row)" :disabled="scope.row.roleKey === 'admin'">删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>

                                <!-- 分页 -->
                                <div class="mt-4 flex justify-end">
                                    <el-pagination
                                        v-model:current-page="rolePagination.currentPage"
                                        v-model:page-size="rolePagination.pageSize"
                                        :page-sizes="[10, 20, 50, 100]"
                                        :total="rolePagination.total"
                                        layout="total, sizes, prev, pager, next, jumper">
                                    </el-pagination>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增/编辑用户对话框 -->
        <el-dialog v-model="userDialogVisible" :title="userDialogTitle" width="600px">
            <el-form :model="userForm" :rules="userRules" ref="userFormRef" label-width="100px">
                <el-form-item label="用户名" prop="username">
                    <el-input v-model="userForm.username" :disabled="userForm.id" placeholder="请输入用户名"></el-input>
                </el-form-item>
                <el-form-item label="姓名" prop="realName">
                    <el-input v-model="userForm.realName" placeholder="请输入姓名" maxlength="10" show-word-limit></el-input>
                </el-form-item>
                <el-form-item label="手机号" prop="phoneNumber">
                    <el-input v-model="userForm.phoneNumber" placeholder="请输入手机号" maxlength="11"></el-input>
                </el-form-item>
                <el-form-item label="邮箱" prop="email">
                    <el-input v-model="userForm.email" placeholder="请输入邮箱" maxlength="100"></el-input>
                </el-form-item>
                <el-form-item label="所属部门">
                    <el-select v-model="userForm.deptId" placeholder="请选择部门" style="width: 100%">
                        <el-option v-for="dept in departments" :key="dept.id" :label="dept.name" :value="dept.id"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="用户角色" prop="roleIds">
                    <el-select v-model="userForm.roleIds" placeholder="请选择角色" multiple style="width: 100%">
                        <el-option v-for="role in roles" :key="role.id" :label="role.roleName" :value="role.id"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="用户密码" prop="password" v-if="!userForm.id">
                    <el-input v-model="userForm.password" type="password" placeholder="请输入用户密码" show-password maxlength="30"></el-input>
                </el-form-item>
                <el-form-item label="确认密码" prop="confirmPassword" v-if="!userForm.id">
                    <el-input v-model="userForm.confirmPassword" type="password" placeholder="请再次输入密码" show-password maxlength="30"></el-input>
                </el-form-item>
                <el-form-item label="备注" prop="remark">
                    <el-input v-model="userForm.remark" type="textarea" :rows="3" placeholder="请输入备注" maxlength="200" show-word-limit></el-input>
                </el-form-item>
                <el-form-item label="状态">
                    <el-radio-group v-model="userForm.status">
                        <el-radio :label="1">启用</el-radio>
                        <el-radio :label="0">禁用</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="userDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveUser">确定</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 新增/编辑角色对话框 -->
        <el-dialog v-model="roleDialogVisible" :title="roleDialogTitle" width="600px">
            <el-form :model="roleForm" :rules="roleRules" ref="roleFormRef" label-width="100px">
                <el-form-item label="角色名称" prop="roleName">
                    <el-input v-model="roleForm.roleName" placeholder="请输入角色名称"></el-input>
                </el-form-item>
                <el-form-item label="角色标识" prop="roleKey">
                    <el-input v-model="roleForm.roleKey" :disabled="roleForm.id" placeholder="请输入角色标识（英文）"></el-input>
                </el-form-item>
                <el-form-item label="角色描述">
                    <el-input v-model="roleForm.description" type="textarea" :rows="3" placeholder="请输入角色描述"></el-input>
                </el-form-item>
                <el-form-item label="状态">
                    <el-radio-group v-model="roleForm.status">
                        <el-radio :label="1">启用</el-radio>
                        <el-radio :label="0">禁用</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="roleDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveRole">确定</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 分配角色对话框 -->
        <el-dialog v-model="assignRoleDialogVisible" title="分配角色" width="400px">
            <div class="mb-4">
                <strong>用户：</strong>{{ selectedUser.realName }} ({{ selectedUser.username }})
            </div>
            <div class="role-assignment-container">
                <div class="mb-3">
                    <span class="text-sm text-gray-600">请选择要分配的角色：</span>
                </div>
                <el-checkbox-group v-model="selectedUserRoleIds" class="flex flex-col space-y-2">
                    <el-checkbox 
                        v-for="role in roles" 
                        :key="role.id" 
                        :label="role.id"
                        :disabled="role.status === 0"
                        class="role-checkbox">
                        <span class="flex items-center justify-between w-full">
                            <span>{{ role.roleName }}</span>
                            <el-tag :type="role.status === 1 ? 'success' : 'danger'" size="small">
                                {{ role.status === 1 ? '启用' : '禁用' }}
                            </el-tag>
                        </span>
                    </el-checkbox>
                </el-checkbox-group>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="assignRoleDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveUserRoles">确定</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 角色授权对话框 -->
        <el-dialog v-model="permissionDialogVisible" title="角色授权" width="600px">
            <div class="mb-4">
                <strong>角色：</strong>{{ selectedRole.roleName }} ({{ selectedRole.roleKey }})
            </div>
            <div class="permission-tree">
                <el-tree
                    ref="permissionTreeRef"
                    :data="permissionTree"
                    :props="{ children: 'children', label: 'label' }"
                    show-checkbox
                    node-key="id"
                    :default-checked-keys="selectedPermissions"
                    :check-strictly="false">
                </el-tree>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="permissionDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveRolePermissions">确定</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 新增/编辑部门对话框 -->
        <el-dialog v-model="deptDialogVisible" :title="deptDialogTitle" width="600px">
            <el-form :model="deptForm" :rules="deptRules" ref="deptFormRef" label-width="100px">
                <el-form-item label="上级部门">
                    <el-tree-select
                        v-model="deptForm.parentId"
                        :data="deptTreeDataWithRoot"
                        :props="{ children: 'children', label: 'deptName', value: 'id' }"
                        placeholder="请选择上级部门"
                        check-strictly
                        :render-after-expand="false"
                        style="width: 100%">
                    </el-tree-select>
                </el-form-item>
                <el-form-item label="部门名称" prop="deptName">
                    <el-input v-model="deptForm.deptName" placeholder="请输入部门名称"></el-input>
                </el-form-item>
                <el-form-item label="显示排序" prop="orderNum">
                    <el-input-number v-model="deptForm.orderNum" :min="0" :max="999" controls-position="right" style="width: 100%"></el-input-number>
                </el-form-item>
                <el-form-item label="负责人">
                    <el-input v-model="deptForm.leader" placeholder="请输入负责人"></el-input>
                </el-form-item>
                <el-form-item label="联系电话">
                    <el-input v-model="deptForm.phone" placeholder="请输入联系电话"></el-input>
                </el-form-item>
                <el-form-item label="邮箱">
                    <el-input v-model="deptForm.email" placeholder="请输入邮箱"></el-input>
                </el-form-item>
                <el-form-item label="部门状态">
                    <el-radio-group v-model="deptForm.status">
                        <el-radio :label="1">启用</el-radio>
                        <el-radio :label="0">禁用</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="deptDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveDept">确定</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    activeMenu: 'system', // 添加导航状态变量
                    activeTab: 'users',
                    currentUser: {
                        name: '系统管理员'
                    },
                    // 用户信息
                    userInfo: {
                        username: 'admin',
                        realName: '张三',
                        department: '系统管理员',
                        avatarUrl: 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'
                    },
                    
                    // 用户管理相关数据
                    userLoading: false,
                    userFilters: {
                        username: '',
                        realName: '',
                        phoneNumber: '',
                        status: ''
                    },
                    userPagination: {
                        currentPage: 1,
                        pageSize: 10,
                        total: 0
                    },
                    users: [
                        {
                            id: 1,
                            username: 'admin',
                            realName: '系统管理员',
                            phoneNumber: '13800138000',
                            email: 'admin@example.com',
                            department: '技术部',
                            roles: ['系统管理员'],
                            status: 1,
                            createTime: '2024-01-01 10:00:00'
                        },
                        {
                            id: 2,
                            username: 'operator',
                            realName: '运营人员',
                            phoneNumber: '13800138001',
                            email: 'operator@example.com',
                            department: '运营部',
                            roles: ['运营人员'],
                            status: 1,
                            createTime: '2024-01-02 10:00:00'
                        },
                        {
                            id: 3,
                            username: 'viewer',
                            realName: '查看员',
                            phoneNumber: '13800138002',
                            email: 'viewer@example.com',
                            department: '业务部',
                            roles: ['查看员'],
                            status: 0,
                            createTime: '2024-01-03 10:00:00'
                        }
                    ],
                    userDialogVisible: false,
                    userDialogTitle: '',
                    userForm: {
                    id: null,
                    username: '',
                    realName: '',
                    phoneNumber: '',
                    email: '',
                    deptId: null,
                    roleIds: [],
                    password: '',
                    confirmPassword: '',
                    remark: '',
                    status: 1
                },
                    userRules: {
                        username: [
                            { required: true, message: '请输入用户名', trigger: 'blur' },
                            { min: 1, max: 10, message: '用户名长度为1-10个字符', trigger: 'blur' },
                            { pattern: /^[\u4e00-\u9fa5a-zA-Z0-9]+$/, message: '用户名只能包含中英文数字', trigger: 'blur' },
                            { validator: this.validateUsernameUnique, trigger: 'blur' }
                        ],
                        realName: [
                            { required: true, message: '请输入姓名', trigger: 'blur' },
                            { min: 1, max: 10, message: '姓名长度为1-10个字符', trigger: 'blur' },
                            { pattern: /^[\u4e00-\u9fa5a-zA-Z0-9]+$/, message: '姓名只能包含中英文数字', trigger: 'blur' }
                        ],
                        phoneNumber: [
                            { required: true, message: '请输入手机号', trigger: 'blur' },
                            { pattern: /^1\d{10}$/, message: '请输入以1开头的11位手机号', trigger: 'blur' },
                            { validator: this.validatePhoneUnique, trigger: 'blur' }
                        ],
                        email: [
                             { max: 100, message: '邮箱长度不能超过100个字符', trigger: 'blur' },
                             { pattern: /^[^@]+@[^@]+\.[^@]+$/, message: '请输入正确的邮箱格式', trigger: 'blur' },
                             { validator: this.validateEmailUnique, trigger: 'blur' }
                         ],
                        password: [
                            { required: true, message: '请输入密码', trigger: 'blur' },
                            { min: 8, max: 30, message: '密码长度为8-30位', trigger: 'blur' },
                            { validator: this.validatePassword, trigger: 'blur' }
                        ],
                        confirmPassword: [
                            { required: true, message: '请再次输入密码', trigger: 'blur' },
                            { validator: this.validateConfirmPassword, trigger: 'blur' }
                        ],
                        remark: [
                             { max: 200, message: '备注长度不能超过200个字符', trigger: 'blur' },
                             { pattern: /^[\u4e00-\u9fa5a-zA-Z0-9\s\.,;:!?()\[\]{}"'\-_+=*&%$#@~`|\\/<>]*$/, message: '备注只能包含中英文数字及常见符号', trigger: 'blur' }
                         ]
                    },
                    departments: [
                        { id: 1, name: '技术部' },
                        { id: 2, name: '运营部' },
                        { id: 3, name: '业务部' },
                        { id: 4, name: '市场部' }
                    ],
                    
                    // 角色管理相关数据
                    roleLoading: false,
                    roleFilters: {
                        roleName: ''
                    },
                    rolePagination: {
                        currentPage: 1,
                        pageSize: 10,
                        total: 0
                    },
                    roles: [
                        {
                            id: 1,
                            roleName: '系统管理员',
                            roleKey: 'admin',
                            description: '系统超级管理员，拥有所有权限',
                            status: 1,
                            createTime: '2024-01-01 10:00:00'
                        },
                        {
                            id: 2,
                            roleName: '运营人员',
                            roleKey: 'operator',
                            description: '运营管理人员，负责日常运营工作',
                            status: 1,
                            createTime: '2024-01-01 10:00:00'
                        },
                        {
                            id: 3,
                            roleName: '查看员',
                            roleKey: 'viewer',
                            description: '只读权限，可查看相关数据',
                            status: 1,
                            createTime: '2024-01-01 10:00:00'
                        }
                    ],
                    roleDialogVisible: false,
                    roleDialogTitle: '',
                    roleForm: {
                        id: null,
                        roleName: '',
                        roleKey: '',
                        description: '',
                        status: 1
                    },
                    roleRules: {
                        roleName: [{ required: true, message: '请输入角色名称', trigger: 'blur' }],
                        roleKey: [{ required: true, message: '请输入角色标识', trigger: 'blur' }]
                    },
                    
                    // 分配角色相关数据
                    assignRoleDialogVisible: false,
                    selectedUser: {},
                    selectedUserRoleIds: [],
                    
                    // 角色授权相关数据
                    permissionDialogVisible: false,
                    selectedRole: {},
                    selectedPermissions: [],
                    permissionTree: [
                        {
                            id: 1,
                            label: '运营门户',
                            children: [
                                { id: 11, label: '驾驶舱' },
                                { id: 12, label: '客户管理' },
                                {
                                    id: 13,
                                    label: '运营分析',
                                    children: [
                                        { id: 131, label: '客户分析' },
                                        { id: 132, label: '设备分析' },
                                        { id: 133, label: '业务分析' }
                                    ]
                                },

                                {
                                    id: 15,
                                    label: '系统配置',
                                    children: [
                                        { id: 151, label: '用户管理' },
                                        { id: 152, label: '角色管理' }
                                    ]
                                },
                                {
                                    id: 16,
                                    label: '日志管理',
                                    children: [
                                        { id: 161, label: '登录日志' },
                                        { id: 162, label: '操作日志' }
                                    ]
                                }
                            ]
                        },
                        {
                            id: 2,
                            label: '接口适配',
                            children: [
                                { id: 21, label: '接入平台管理' },
                                { id: 22, label: '设备管理' },
                                { id: 23, label: '通道管理' }
                            ]
                        },
                        {
                            id: 3,
                            label: '业务数据采集',
                            children: [
                                { id: 31, label: '业务采集设置' },
                                { id: 32, label: '客户同步设置' },
                                { id: 33, label: '任务状态' }
                            ]
                        },
                        {
                            id: 17,
                            deptName: '北京分公司',
                            parentId: 0,
                            orderNum: 2,
                            leader: '张分总',
                            phone: '13800138017',
                            email: 'beijing@example.com',
                            status: 1,
                            createTime: '2024-01-15 10:00:00',
                            children: [
                                {
                                    id: 18,
                                    deptName: '北京技术部',
                                    parentId: 17,
                                    orderNum: 1,
                                    leader: '李部长',
                                    phone: '13800138018',
                                    email: 'bjtech@example.com',
                                    status: 1,
                                    createTime: '2024-01-15 10:00:00'
                                },
                                {
                                    id: 19,
                                    deptName: '北京销售部',
                                    parentId: 17,
                                    orderNum: 2,
                                    leader: '王部长',
                                    phone: '13800138019',
                                    email: 'bjsales@example.com',
                                    status: 1,
                                    createTime: '2024-01-15 10:00:00'
                                }
                            ]
                        },
                        {
                            id: 20,
                            deptName: '上海分公司',
                            parentId: 0,
                            orderNum: 3,
                            leader: '赵分总',
                            phone: '13800138020',
                            email: 'shanghai@example.com',
                            status: 1,
                            createTime: '2024-02-01 10:00:00',
                            children: [
                                {
                                    id: 21,
                                    deptName: '上海运营部',
                                    parentId: 20,
                                    orderNum: 1,
                                    leader: '陈部长',
                                    phone: '13800138021',
                                    email: 'shoperation@example.com',
                                    status: 1,
                                    createTime: '2024-02-01 10:00:00'
                                },
                                {
                                    id: 22,
                                    deptName: '上海客服部',
                                    parentId: 20,
                                    orderNum: 2,
                                    leader: '刘部长',
                                    phone: '13800138022',
                                    email: 'shservice@example.com',
                                    status: 1,
                                    createTime: '2024-02-01 10:00:00'
                                }
                            ]
                        },
                        {
                            id: 23,
                            deptName: '深圳分公司',
                            parentId: 0,
                            orderNum: 4,
                            leader: '周分总',
                            phone: '13800138023',
                            email: 'shenzhen@example.com',
                            status: 0,
                            createTime: '2024-03-01 10:00:00',
                            children: [
                                {
                                    id: 24,
                                    deptName: '深圳研发部',
                                    parentId: 23,
                                    orderNum: 1,
                                    leader: '吴部长',
                                    phone: '13800138024',
                                    email: 'szrd@example.com',
                                    status: 1,
                                    createTime: '2024-03-01 10:00:00'
                                }
                            ]
                        }
                    ],
                    
                    // 部门管理相关数据
                    deptLoading: false,
                    deptFilters: {
                        deptName: '',
                        status: ''
                    },
                    deptPagination: {
                        currentPage: 1,
                        pageSize: 10,
                        total: 0
                    },
                    departments: [
                        {
                            id: 1,
                            deptName: '视联网科技有限公司',
                            parentId: 0,
                            orderNum: 1,
                            leader: '张总',
                            phone: '13800138000',
                            email: 'ceo@example.com',
                            status: 1,
                            createTime: '2024-01-01 10:00:00',
                            children: [
                                {
                                    id: 2,
                                    deptName: '技术部',
                                    parentId: 1,
                                    orderNum: 1,
                                    leader: '李经理',
                                    phone: '13800138001',
                                    email: 'tech@example.com',
                                    status: 1,
                                    createTime: '2024-01-01 10:00:00',
                                    children: [
                                        {
                                            id: 5,
                                            deptName: '前端开发组',
                                            parentId: 2,
                                            orderNum: 1,
                                            leader: '王组长',
                                            phone: '13800138005',
                                            email: 'frontend@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        },
                                        {
                                            id: 6,
                                            deptName: '后端开发组',
                                            parentId: 2,
                                            orderNum: 2,
                                            leader: '赵组长',
                                            phone: '13800138006',
                                            email: 'backend@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        }
                                    ]
                                },
                                {
                                    id: 3,
                                    deptName: '运营部',
                                    parentId: 1,
                                    orderNum: 2,
                                    leader: '刘经理',
                                    phone: '13800138002',
                                    email: 'operation@example.com',
                                    status: 1,
                                    createTime: '2024-01-01 10:00:00',
                                    children: [
                                        {
                                            id: 7,
                                            deptName: '市场推广组',
                                            parentId: 3,
                                            orderNum: 1,
                                            leader: '周组长',
                                            phone: '13800138007',
                                            email: 'marketing@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        },
                                        {
                                            id: 8,
                                            deptName: '客户服务组',
                                            parentId: 3,
                                            orderNum: 2,
                                            leader: '吴组长',
                                            phone: '13800138008',
                                            email: 'service@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        }
                                    ]
                                },
                                {
                                    id: 4,
                                    deptName: '业务部',
                                    parentId: 1,
                                    orderNum: 3,
                                    leader: '陈经理',
                                    phone: '13800138003',
                                    email: 'business@example.com',
                                    status: 1,
                                    createTime: '2024-01-01 10:00:00',
                                    children: [
                                        {
                                            id: 9,
                                            deptName: '销售一组',
                                            parentId: 4,
                                            orderNum: 1,
                                            leader: '郑组长',
                                            phone: '13800138009',
                                            email: 'sales1@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        },
                                        {
                                            id: 10,
                                            deptName: '销售二组',
                                            parentId: 4,
                                            orderNum: 2,
                                            leader: '孙组长',
                                            phone: '13800138010',
                                            email: 'sales2@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        },
                                        {
                                            id: 11,
                                            deptName: '商务支持组',
                                            parentId: 4,
                                            orderNum: 3,
                                            leader: '钱组长',
                                            phone: '13800138011',
                                            email: 'support@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        }
                                    ]
                                },
                                {
                                    id: 12,
                                    deptName: '人力资源部',
                                    parentId: 1,
                                    orderNum: 4,
                                    leader: '许经理',
                                    phone: '13800138012',
                                    email: 'hr@example.com',
                                    status: 1,
                                    createTime: '2024-01-01 10:00:00',
                                    children: [
                                        {
                                            id: 13,
                                            deptName: '招聘培训组',
                                            parentId: 12,
                                            orderNum: 1,
                                            leader: '何组长',
                                            phone: '13800138013',
                                            email: 'recruit@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        },
                                        {
                                            id: 14,
                                            deptName: '薪酬绩效组',
                                            parentId: 12,
                                            orderNum: 2,
                                            leader: '卢组长',
                                            phone: '13800138014',
                                            email: 'salary@example.com',
                                            status: 1,
                                            createTime: '2024-01-01 10:00:00'
                                        }
                                    ]
                                },
                                {
                                    id: 15,
                                    deptName: '财务部',
                                    parentId: 1,
                                    orderNum: 5,
                                    leader: '沈经理',
                                    phone: '13800138015',
                                    email: 'finance@example.com',
                                    status: 1,
                                    createTime: '2024-01-01 10:00:00'
                                },
                                {
                                    id: 16,
                                    deptName: '行政部',
                                    parentId: 1,
                                    orderNum: 6,
                                    leader: '韩经理',
                                    phone: '13800138016',
                                    email: 'admin@example.com',
                                    status: 0,
                                    createTime: '2024-01-01 10:00:00'
                                }
                            ]
                        }
                    ],
                    deptDialogVisible: false,
                    deptDialogTitle: '',
                    deptForm: {
                        id: null,
                        parentId: 0,
                        deptName: '',
                        orderNum: 1,
                        leader: '',
                        phone: '',
                        email: '',
                        status: 1
                    },
                    deptRules: {
                        deptName: [{ required: true, message: '请输入部门名称', trigger: 'blur' }],
                        orderNum: [{ required: true, message: '请输入显示排序', trigger: 'blur' }]
                    },
                    deptTreeData: []
                };
            },
            computed: {
                filteredUsers() {
                    let filtered = this.users;
                    if (this.userFilters.username) {
                        filtered = filtered.filter(user => user.username.includes(this.userFilters.username));
                    }
                    if (this.userFilters.realName) {
                        filtered = filtered.filter(user => user.realName.includes(this.userFilters.realName));
                    }
                    if (this.userFilters.phoneNumber) {
                        filtered = filtered.filter(user => user.phoneNumber.includes(this.userFilters.phoneNumber));
                    }
                    if (this.userFilters.status !== '') {
                        filtered = filtered.filter(user => user.status == this.userFilters.status);
                    }
                    this.userPagination.total = filtered.length;
                    return filtered;
                },
                filteredRoles() {
                    let filtered = this.roles;
                    if (this.roleFilters.roleName) {
                        filtered = filtered.filter(role => role.roleName.includes(this.roleFilters.roleName));
                    }
                    this.rolePagination.total = filtered.length;
                    return filtered;
                },
                filteredDepts() {
                    let filtered = this.departments;
                    if (this.deptFilters.deptName) {
                        // 递归过滤部门树
                        const filterDeptTree = (depts) => {
                            return depts.filter(dept => {
                                const nameMatch = dept.deptName.includes(this.deptFilters.deptName);
                                if (dept.children && dept.children.length > 0) {
                                    dept.children = filterDeptTree(dept.children);
                                    return nameMatch || dept.children.length > 0;
                                }
                                return nameMatch;
                            });
                        };
                        filtered = filterDeptTree([...filtered]);
                    }
                    if (this.deptFilters.status !== '') {
                        // 递归过滤状态
                        const filterByStatus = (depts) => {
                            return depts.filter(dept => {
                                const statusMatch = dept.status == this.deptFilters.status;
                                if (dept.children && dept.children.length > 0) {
                                    dept.children = filterByStatus(dept.children);
                                    return statusMatch || dept.children.length > 0;
                                }
                                return statusMatch;
                            });
                        };
                        filtered = filterByStatus(filtered);
                    }
                    // 计算总数（包括子部门）
                    const countDepts = (depts) => {
                        let count = 0;
                        depts.forEach(dept => {
                            count++;
                            if (dept.children && dept.children.length > 0) {
                                count += countDepts(dept.children);
                            }
                        });
                        return count;
                    };
                    this.deptPagination.total = countDepts(filtered);
                    return filtered;
                },
                deptTreeDataWithRoot() {
                    // 为上级部门选择器添加根节点选项
                    const rootOption = {
                        id: 0,
                        deptName: '无',
                        children: [...this.departments]
                    };
                    return [rootOption];
                }
            },
            methods: {
                // 自定义验证方法
                validatePassword(rule, value, callback) {
                    if (!value) {
                        callback();
                        return;
                    }
                    
                    // 检查密码复杂度：包含大写字母、小写字母、数字及特殊符号
                    const hasUpper = /[A-Z]/.test(value);
                    const hasLower = /[a-z]/.test(value);
                    const hasNumber = /\d/.test(value);
                    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(value);
                    
                    if (!(hasUpper && hasLower && hasNumber && hasSpecial)) {
                        callback(new Error('密码必须包含大写字母、小写字母、数字及特殊符号'));
                        return;
                    }
                    
                    // 检查不包含用户名
                    if (this.userForm.username && value.toLowerCase().includes(this.userForm.username.toLowerCase())) {
                        callback(new Error('密码不能包含用户名'));
                        return;
                    }
                    
                    // 检查3位键盘排序字符
                    const keyboardSequences = [
                        'qwe', 'wer', 'ert', 'rty', 'tyu', 'yui', 'uio', 'iop',
                        'asd', 'sdf', 'dfg', 'fgh', 'ghj', 'hjk', 'jkl',
                        'zxc', 'xcv', 'cvb', 'vbn', 'bnm',
                        '123', '234', '345', '456', '567', '678', '789', '890'
                    ];
                    
                    for (let seq of keyboardSequences) {
                        if (value.toLowerCase().includes(seq) || value.toLowerCase().includes(seq.split('').reverse().join(''))) {
                            callback(new Error('密码不能包含3位连续的键盘字符'));
                            return;
                        }
                    }
                    
                    // 检查3位连续字母
                    for (let i = 0; i < value.length - 2; i++) {
                        const char1 = value.charCodeAt(i);
                        const char2 = value.charCodeAt(i + 1);
                        const char3 = value.charCodeAt(i + 2);
                        
                        if ((char2 === char1 + 1 && char3 === char2 + 1) || 
                            (char2 === char1 - 1 && char3 === char2 - 1)) {
                            callback(new Error('密码不能包含3位连续的字母'));
                            return;
                        }
                    }
                    
                    // 检查3位重复字符
                    for (let i = 0; i < value.length - 2; i++) {
                        if (value[i] === value[i + 1] && value[i + 1] === value[i + 2]) {
                            callback(new Error('密码不能包含3位重复字符'));
                            return;
                        }
                    }
                    
                    callback();
                },
                
                validateConfirmPassword(rule, value, callback) {
                    if (!value) {
                        callback(new Error('请再次输入密码'));
                        return;
                    }
                    if (value !== this.userForm.password) {
                        callback(new Error('两次输入的密码不一致'));
                        return;
                    }
                    callback();
                },
                
                validateUsernameUnique(rule, value, callback) {
                    if (!value) {
                        callback();
                        return;
                    }
                    
                    // 检查用户名是否重复（排除当前编辑的用户）
                    const existingUser = this.users.find(user => 
                        user.username === value && user.id !== this.userForm.id
                    );
                    
                    if (existingUser) {
                        callback(new Error('该用户名已存在'));
                        return;
                    }
                    
                    callback();
                },
                
                validatePhoneUnique(rule, value, callback) {
                    if (!value) {
                        callback();
                        return;
                    }
                    
                    // 检查手机号是否重复（排除当前编辑的用户）
                    const existingUser = this.users.find(user => 
                        user.phoneNumber === value && user.id !== this.userForm.id
                    );
                    
                    if (existingUser) {
                        callback(new Error('该手机号已存在'));
                        return;
                    }
                    
                    callback();
                },
                
                validateEmailUnique(rule, value, callback) {
                    if (!value) {
                        callback();
                        return;
                    }
                    
                    // 检查邮箱是否重复（排除当前编辑的用户）
                    const existingUser = this.users.find(user => 
                        user.email === value && user.id !== this.userForm.id
                    );
                    
                    if (existingUser) {
                        callback(new Error('该邮箱已存在'));
                        return;
                    }
                    
                    callback();
                },
                
                // 用户相关方法
                handleUserCommand(command) {
                    switch(command) {
                        case 'profile':
                            this.goToProfile();
                            break;
                        case 'password':
                            this.showChangePassword();
                            break;
                        case 'logout':
                            this.logout();
                            break;
                    }
                },
                goToProfile() {
                    this.$message.info('跳转到个人中心');
                    // 这里可以添加路由跳转逻辑
                },
                showChangePassword() {
                    this.$message.info('打开修改密码对话框');
                    // 这里可以添加修改密码的逻辑
                },
                logout() {
                    this.$confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.$message.success('退出登录成功');
                        // 这里可以添加退出登录的逻辑
                    }).catch(() => {
                        this.$message.info('已取消退出');
                    });
                },
                
                // 用户管理方法
                searchUsers() {
                    this.userLoading = true;
                    setTimeout(() => {
                        this.userLoading = false;
                    }, 500);
                },
                resetUserFilters() {
                    this.userFilters = {
                        username: '',
                        realName: '',
                        phoneNumber: '',
                        status: ''
                    };
                },
                showAddUserDialog() {
                    this.userDialogTitle = '新增用户';
                    this.userForm = {
                        id: null,
                        username: '',
                        realName: '',
                        phoneNumber: '',
                        email: '',
                        deptId: null,
                        roleIds: [],
                        password: '',
                        confirmPassword: '',
                        remark: '',
                        status: 1
                    };
                    this.userDialogVisible = true;
                },
                editUser(user) {
                    this.userDialogTitle = '编辑用户';
                    this.userForm = { ...user };
                    this.userDialogVisible = true;
                },
                saveUser() {
                    this.$refs.userFormRef.validate((valid) => {
                        if (valid) {
                            if (this.userForm.id) {
                                // 编辑用户
                                const index = this.users.findIndex(u => u.id === this.userForm.id);
                                if (index !== -1) {
                                    this.users[index] = { ...this.userForm };
                                }
                                ElMessage.success('用户信息修改成功');
                            } else {
                                // 新增用户
                                this.userForm.id = Date.now();
                                this.userForm.createTime = new Date().toLocaleString();
                                this.users.push({ ...this.userForm });
                                ElMessage.success('新增用户成功');
                            }
                            this.userDialogVisible = false;
                        }
                    });
                },
                toggleUserStatus(user) {
                    const action = user.status === 1 ? '禁用' : '启用';
                    ElMessageBox.confirm(`确定要${action}用户 ${user.username} 吗？`, '确认操作', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        user.status = user.status === 1 ? 0 : 1;
                        ElMessage.success(`用户状态修改成功`);
                    });
                },
                deleteUser(user) {
                    if (user.username === 'admin') {
                        ElMessage.warning('超级管理员账户不允许删除');
                        return;
                    }
                    ElMessageBox.confirm(`确定要删除用户 ${user.username} 吗？此操作不可恢复。`, '确认删除', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        const index = this.users.findIndex(u => u.id === user.id);
                        if (index !== -1) {
                            this.users.splice(index, 1);
                        }
                        ElMessage.success('用户删除成功');
                    });
                },
                assignRoles(user) {
                    this.selectedUser = user;
                    // 获取用户当前角色ID列表
                    const currentRoleNames = user.roles || [];
                    this.selectedUserRoleIds = this.roles
                        .filter(role => currentRoleNames.includes(role.roleName))
                        .map(role => role.id);
                    this.assignRoleDialogVisible = true;
                },
                saveUserRoles() {
                    // 更新用户角色
                    const roleNames = this.selectedUserRoleIds.map(roleId => {
                        const role = this.roles.find(r => r.id === roleId);
                        return role ? role.roleName : '';
                    }).filter(name => name);
                    
                    const userIndex = this.users.findIndex(u => u.id === this.selectedUser.id);
                    if (userIndex !== -1) {
                        this.users[userIndex].roles = roleNames;
                    }
                    
                    this.assignRoleDialogVisible = false;
                    ElMessage.success('角色分配成功');
                },
                
                // 角色管理方法
                searchRoles() {
                    this.roleLoading = true;
                    setTimeout(() => {
                        this.roleLoading = false;
                    }, 500);
                },
                resetRoleFilters() {
                    this.roleFilters = {
                        roleName: ''
                    };
                },
                showAddRoleDialog() {
                    this.roleDialogTitle = '新增角色';
                    this.roleForm = {
                        id: null,
                        roleName: '',
                        roleKey: '',
                        description: '',
                        status: 1
                    };
                    this.roleDialogVisible = true;
                },
                editRole(role) {
                    this.roleDialogTitle = '编辑角色';
                    this.roleForm = { ...role };
                    this.roleDialogVisible = true;
                },
                saveRole() {
                    this.$refs.roleFormRef.validate((valid) => {
                        if (valid) {
                            if (this.roleForm.id) {
                                // 编辑角色
                                const index = this.roles.findIndex(r => r.id === this.roleForm.id);
                                if (index !== -1) {
                                    this.roles[index] = { ...this.roleForm };
                                }
                                ElMessage.success('角色信息修改成功');
                            } else {
                                // 新增角色
                                this.roleForm.id = Date.now();
                                this.roleForm.createTime = new Date().toLocaleString();
                                this.roles.push({ ...this.roleForm });
                                ElMessage.success('新增角色成功');
                            }
                            this.roleDialogVisible = false;
                        }
                    });
                },
                toggleRoleStatus(role) {
                    const action = role.status === 1 ? '禁用' : '启用';
                    ElMessageBox.confirm(`确定要${action}角色 ${role.roleName} 吗？${action === '禁用' ? '禁用后，拥有此角色的用户将临时失去相应权限。' : ''}`, '确认操作', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        role.status = role.status === 1 ? 0 : 1;
                        ElMessage.success(`角色状态修改成功`);
                    });
                },
                deleteRole(role) {
                    if (role.roleKey === 'admin') {
                        ElMessage.warning('内置保护角色，不允许删除');
                        return;
                    }
                    ElMessageBox.confirm(`确定要删除角色 ${role.roleName} 吗？删除后，拥有此角色的用户将失去相应权限。`, '确认删除', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        const index = this.roles.findIndex(r => r.id === role.id);
                        if (index !== -1) {
                            this.roles.splice(index, 1);
                        }
                        ElMessage.success('角色删除成功');
                    });
                },
                assignPermissions(role) {
                    this.selectedRole = role;
                    // 模拟角色已有权限
                    if (role.roleKey === 'admin') {
                        this.selectedPermissions = [1, 11, 12, 13, 131, 132, 133, 14, 141, 142, 15, 151, 152, 16, 161, 162, 2, 21, 22, 23, 3, 31, 32, 33];
                    } else if (role.roleKey === 'operator') {
                        this.selectedPermissions = [1, 11, 12, 13, 131, 132, 133, 14, 141, 142];
                    } else {
                        this.selectedPermissions = [1, 11, 12];
                    }
                    this.permissionDialogVisible = true;
                },
                saveRolePermissions() {
                    const checkedKeys = this.$refs.permissionTreeRef.getCheckedKeys();
                    const halfCheckedKeys = this.$refs.permissionTreeRef.getHalfCheckedKeys();
                    const allCheckedKeys = [...checkedKeys, ...halfCheckedKeys];
                    
                    // 这里可以保存权限到后端
                    console.log('保存角色权限:', this.selectedRole.roleName, allCheckedKeys);
                    
                    this.permissionDialogVisible = false;
                    ElMessage.success('角色授权成功');
                },
                
                // 部门管理方法
                searchDepts() {
                    this.deptLoading = true;
                    setTimeout(() => {
                        this.deptLoading = false;
                    }, 500);
                },
                resetDeptFilters() {
                    this.deptFilters = {
                        deptName: '',
                        status: ''
                    };
                },
                showAddDeptDialog() {
                    this.deptDialogTitle = '新增部门';
                    this.deptForm = {
                        id: null,
                        parentId: 0,
                        deptName: '',
                        orderNum: 1,
                        leader: '',
                        phone: '',
                        email: '',
                        status: 1
                    };
                    this.deptDialogVisible = true;
                },
                editDept(dept) {
                    this.deptDialogTitle = '编辑部门';
                    this.deptForm = { ...dept };
                    this.deptDialogVisible = true;
                },
                saveDept() {
                    this.$refs.deptFormRef.validate((valid) => {
                        if (valid) {
                            if (this.deptForm.id) {
                                // 编辑部门
                                this.updateDeptInTree(this.departments, this.deptForm);
                                ElMessage.success('部门信息修改成功');
                            } else {
                                // 新增部门
                                this.deptForm.id = Date.now();
                                this.deptForm.createTime = new Date().toLocaleString();
                                this.addDeptToTree(this.departments, this.deptForm);
                                ElMessage.success('新增部门成功');
                            }
                            this.deptDialogVisible = false;
                        }
                    });
                },
                updateDeptInTree(tree, dept) {
                    for (let i = 0; i < tree.length; i++) {
                        if (tree[i].id === dept.id) {
                            Object.assign(tree[i], dept);
                            return true;
                        }
                        if (tree[i].children && this.updateDeptInTree(tree[i].children, dept)) {
                            return true;
                        }
                    }
                    return false;
                },
                addDeptToTree(tree, dept) {
                    if (dept.parentId === 0) {
                        tree.push(dept);
                        return;
                    }
                    for (let i = 0; i < tree.length; i++) {
                        if (tree[i].id === dept.parentId) {
                            if (!tree[i].children) {
                                tree[i].children = [];
                            }
                            tree[i].children.push(dept);
                            return;
                        }
                        if (tree[i].children) {
                            this.addDeptToTree(tree[i].children, dept);
                        }
                    }
                },
                toggleDeptStatus(dept) {
                    const action = dept.status === 1 ? '禁用' : '启用';
                    ElMessageBox.confirm(`确定要${action}部门 ${dept.deptName} 吗？${action === '禁用' ? '禁用后，该部门下的用户将无法正常使用系统。' : ''}`, '确认操作', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        dept.status = dept.status === 1 ? 0 : 1;
                        ElMessage.success(`部门状态修改成功`);
                    });
                },
                deleteDept(dept) {
                    if (dept.children && dept.children.length > 0) {
                        ElMessage.warning('该部门下存在子部门，请先删除子部门');
                        return;
                    }
                    ElMessageBox.confirm(`确定要删除部门 ${dept.deptName} 吗？删除后，该部门下的用户将被移至上级部门。`, '确认删除', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.deleteDeptFromTree(this.departments, dept.id);
                        ElMessage.success('部门删除成功');
                    });
                },
                deleteDeptFromTree(tree, deptId) {
                    for (let i = 0; i < tree.length; i++) {
                        if (tree[i].id === deptId) {
                            tree.splice(i, 1);
                            return true;
                        }
                        if (tree[i].children && this.deleteDeptFromTree(tree[i].children, deptId)) {
                            return true;
                        }
                    }
                    return false;
                },
                expandAll() {
                    this.$refs.deptTableRef.store.states.expandRows.value = this.getAllDeptIds(this.departments);
                },
                collapseAll() {
                    this.$refs.deptTableRef.store.states.expandRows.value = [];
                },
                getAllDeptIds(tree) {
                    let ids = [];
                    tree.forEach(dept => {
                        ids.push(dept);
                        if (dept.children) {
                            ids = ids.concat(this.getAllDeptIds(dept.children));
                        }
                    });
                    return ids;
                }
            },
            mounted() {
                // 初始化分页总数
                this.userPagination.total = this.users.length;
                this.rolePagination.total = this.roles.length;
                this.deptPagination.total = this.departments.length;
                
                // 确保部门表格默认折叠
                this.$nextTick(() => {
                    if (this.$refs.deptTableRef) {
                        this.$refs.deptTableRef.store.states.expandRows.value = [];
                    }
                });
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>