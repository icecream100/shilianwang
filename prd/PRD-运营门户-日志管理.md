# 需求文档 - 日志管理

## 1. 功能概述

- 1.1 功能名称：日志管理
- 1.2 功能概述：日志管理模块为视联网省级适配中心提供全面的日志记录、查询和展示功能。它负责收集并存储适配中心运行过程中的各类关键日志，包括用户登录行为、用户在门户内的重要操作、。

## 2. 用户与场景

- 2.1 目标用户: 省级适配中心系统管理员、运维工程师、安全审计员、技术支持人员。
- 2.2 用户场景/故事:
    - 场景一：作为一个省级适配中心运维工程师，当用户报告无法登录时，我希望能快速查询该用户的登录日志，查看其尝试登录的时间、IP地址及登录结果，以便定位问题原因。
    - 场景二：作为一个省级适配中心系统管理员，当需要审计某项配置（如资源授权）是如何被修改的时，我希望能查询操作日志，追溯到具体的操作人、操作时间以及修改的内容详情。


## 3. 功能范围/列表

- 3.1 功能模块一: 登录日志
- 3.2 功能模块二: 操作日志


## 4. 功能模块详情

---

### 4.1 功能模块：登录日志

#### 4.1.1 功能描述与目标

- 解决的问题: 需要记录所有用户尝试登录适配中心门户的行为，包括成功和失败的尝试，以便进行安全审计和问题排查。
- 用户价值/目标: 提供用户登录行为的可追溯性，帮助管理员监控异常登录尝试，保障系统账户安全，并为用户登录问题提供诊断依据。
- 核心能力概述: 自动记录用户登录适配中心门户的详细信息，包括登录用户、登录时间、来源IP、登录结果（成功/失败）及失败原因。提供按条件查询和展示登录日志的功能。

#### 4.1.2 原型参考

- 主要原型页面: P_Log_Login_List (登录日志列表页)

#### 4.1.3 详细需求

##### 4.1.3.1 功能入口与触发条件

- 入口: 运营门户模块 -> 日志管理 -> 登录日志 [参考原型 P_Log_Login_List]
- 触发条件: 用户已登录，并拥有“登录日志查看”权限。

##### 4.1.3.2 交互流程与界面详述

- **A. 日志列表与查询**: [参考原型 P_Log_Login_List]
    - 布局: 顶部为筛选条件区，下方为登录日志列表。
    - 筛选条件:
        - 用户名: 输入框，支持模糊匹配。
        - 登录IP地址: 输入框。
        - 登录时间范围: 日期时间选择器，选择开始和结束日期时间。
        - 登录结果: 下拉选择（全部、成功、失败）。
    - 日志列表: 表格形式展示。关键列包括：序号、用户名、登录IP地址、登录地理位置（可选，基于IP解析）、客户端类型（如Web浏览器、APP版本）、登录时间、登录结果、失败原因（若登录失败）、会话ID（可选）。
    - 默认交互/排序: 列表默认按登录时间降序排列。提供分页。
- **B. 查看日志详情** (通常列表已展示足够信息，若有更详细内容则需要)
    - 触发: 若有“详情”按钮，点击查看。
    - 交互: 弹出模态框或跳转新页面，展示该条登录日志的全部字段信息。

##### 4.1.3.3 字段定义与数据规则 (日志条目)

|   |   |   |   |
|---|---|---|---|
|**字段名称**|**字段标识 (Eng)**|**数据类型 & 长度**|**说明**|
|日志ID|logId|Long|系统生成，唯一|
|用户名|username|String(50)|尝试登录的用户名|
|登录IP地址|loginIp|String(45)|来源IP地址|
|登录地理位置|loginLocation|String(100)|（可选）根据IP解析的地理位置|
|客户端信息|clientInfo|String(255)|用户代理字符串（User-Agent），包含浏览器、操作系统信息|
|登录时间|loginTime|DateTime|事件发生时间，精确到毫秒|
|登录结果|loginStatus|Enum(SUCCESS, FAILURE)|成功、失败|
|失败原因|failureReason|String(255)|若登录失败，记录失败原因（如：密码错误、用户不存在、账户锁定）|
|会话ID|sessionId|String(100)|（可选）成功登录后的会话标识|
|适配中心节点|adapterNodeId|String(50)|（可选，用于分布式部署）记录处理登录请求的适配中心节点|

##### 4.1.3.4 权限控制

- 功能访问权限: 拥有“登录日志查看”权限的用户可以访问并查询登录日志。

#### 4.1.4 业务规则

- 所有用户（包括管理员和普通用户）尝试登录适配中心门户的行为均需被记录。
- 日志应近实时生成并可供查询。
- 本地日志保留策略：适配中心本地应保留一定期限的登录日志（如近30天或90天，可配置），超期日志可归档或依赖已汇聚至标准版平台的中央日志系统。
- 日志统一汇聚: 登录日志应按照与标准版平台协定的格式，通过指定方式（如Syslog, Kafka, API上报）实时或准实时地汇聚到标准版平台的中央日志管理系统。

#### 4.1.5 异常处理方案 (针对日志查看功能本身)

- 查询超时或失败: 若查询日志数据量过大或数据库响应慢，应有超时控制和友好提示。
- 无符合条件的日志: 列表为空时，显示“未找到符合条件的登录日志”。

#### 4.1.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 用户认证模块: 登录行为由认证模块处理，并触发日志记录。
- **被依赖项 (Generated Dependencies)**:
    - 安全审计流程: 登录日志是安全审计的重要输入。
    - 运维排障: 用于诊断用户登录问题。

---

### 4.2 功能模块：操作日志

#### 4.2.1 功能描述与目标

- 解决的问题: 需要追踪和记录用户在适配中心门户内执行的各项关键操作，以便进行行为审计、责任认定和问题追溯。
- 用户价值/目标: 提供用户操作行为的透明度和可审计性，加强系统安全性，帮助管理员监控敏感操作，并在发生配置错误或违规操作时提供追查依据。
- 核心能力概述: 详细记录用户在适配中心门户执行的关键操作，如配置修改（例如：接入平台配置、设备补充信息编辑、CRM同步配置、角色权限分配等）、资源授权、手动数据同步触发等。提供按条件查询和展示操作日志的功能。

#### 4.2.2 原型参考

- 主要原型页面: P_Log_Operation_List (操作日志列表页)

#### 4.2.3 详细需求

##### 4.2.3.1 功能入口与触发条件

- 入口: 运营门户模块 -> 日志管理 -> 操作日志 [参考原型 P_Log_Operation_List]
- 触发条件: 用户已登录，并拥有“操作日志查看”权限。

##### 4.2.3.2 交互流程与界面详述

- **A. 日志列表与查询**: [参考原型 P_Log_Operation_List]
    - 布局: 顶部为筛选条件区，下方为操作日志列表。
    - 筛选条件:
        - 操作用户: 输入框（用户名），支持模糊匹配。
        - 操作模块/功能名称: 下拉选择或输入框（如：客户管理、设备远程控制、角色授权等）。
        - 操作类型: 下拉选择（如：新增、修改、删除、启用、停用、授权、导出等）。
        - 操作时间范围: 日期时间选择器。
        - 操作对象ID/名称 (可选): 输入框，如被操作的客户ID、设备ID。
        - 操作结果: 下拉选择 (全部、成功、失败)。
    - 日志列表: 表格形式展示。关键列包括：序号、操作用户、用户IP地址、操作模块、功能名称、操作类型、操作对象描述（如“客户：张三 / ID:1001”）、操作时间、操作结果、简要描述/操作内容摘要。操作列可有“查看详情”按钮。
    - 默认交互/排序: 列表默认按操作时间降序排列。提供分页。
- **B. 查看日志详情**:
    - 触发: 点击日志列表操作列的“查看详情”按钮（若摘要不足以展示全部信息）。
    - 交互: 弹出模态框或跳转新页面，展示该条操作日志的全部字段信息，特别是操作前后的数据对比（对于修改操作，若有记录）、完整的请求参数或操作内容。

##### 4.1.3.3 字段定义与数据规则 (日志条目)

|   |   |   |   |
|---|---|---|---|
|**字段名称**|**字段标识 (Eng)**|**数据类型 & 长度**|**说明**|
|日志ID|logId|Long|系统生成，唯一|
|操作用户ID|userId|Long|执行操作的用户ID|
|操作用户名|username|String(50)|执行操作的用户名|
|用户IP地址|userIp|String(45)|操作时用户的IP地址|
|操作模块|moduleName|String(100)|被操作的功能模块，如：接入平台管理、客户授权|
|功能名称|functionName|String(100)|具体的功能点，如：新增接入平台、修改客户授权|
|操作类型|operationType|Enum(CREATE, UPDATE, DELETE, ENABLE, DISABLE, AUTHORIZE, LOGIN, LOGOUT, EXPORT, TRIGGER_SYNC, REMOTE_CONTROL, etc.)|操作的具体类型|
|操作对象类型|targetObjectType|String(50)|（可选）被操作对象的类型，如：Platform, Device, Customer, Role|
|操作对象ID|targetObjectId|String(100)|（可选）被操作对象的主键或业务ID|
|操作对象描述|targetObjectDesc|String(255)|（可选）被操作对象的易读描述，如名称|
|操作时间|operationTime|DateTime|事件发生时间，精确到毫秒|
|操作内容/请求参数|requestPayload|Text|（可选，需脱敏）执行操作时的关键请求参数或提交的数据|
|操作前数据|dataBefore|Text|（可选，针对修改操作）操作前对象关键数据的快照（JSON格式）|
|操作后数据|dataAfter|Text|（可选，针对修改操作）操作后对象关键数据的快照（JSON格式）|
|操作结果|operationStatus|Enum(SUCCESS, FAILURE)|操作执行是否成功|
|结果描述/错误信息|resultMessage|String(500)|若操作失败，记录错误信息；成功则可为空或简要描述|
|适配中心节点|adapterNodeId|String(50)|（可选）处理操作请求的适配中心节点|

##### 4.1.3.4 权限控制

- 功能访问权限: 拥有“操作日志查看”权限的用户可以访问并查询操作日志。

#### 4.2.4 业务规则

- 系统中所有定义为“关键操作”的用户行为均需被记录。关键操作的范围应由产品和安全团队共同定义。
- 日志应包含足够的信息来还原操作场景、追溯责任。对于修改类操作，鼓励记录修改前后的数据对比。
- 请求参数和数据快照在存入日志前，应进行必要的敏感信息脱敏处理（如密码、密钥等字段不应明文记录）。
- 本地日志保留策略与统一汇聚规则同登录日志。

#### 4.2.5 异常处理方案 (针对日志查看功能本身)

- 同登录日志的异常处理方案。

#### 4.2.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 所有需要记录操作日志的功能模块：这些模块在执行关键操作后，需调用日志服务接口记录日志。
- **被依赖项 (Generated Dependencies)**:
    - 安全审计流程: 操作日志是安全审计和合规性检查的核心依据。
    - 运维排障与责任认定。

---
