# 需求文档 - 接口适配模块

## 1. 功能概述

- 1.1 功能名称：接口适配模块
- 1.2 功能概述：接口适配模块是视联网省级适配中心与各省级特有视频平台及相关资源进行对接的核心枢纽。它专注于实现南向接口的协议解析与适配转换、数据适配与整合，并对接入的平台、设备及通道资源进行统一配置和管理。本模块旨在屏蔽底层各省级平台的协议差异，为上层业务应用提供标准化的资源接入和管理能力，确保各类视频资源的顺畅汇聚、高效管理和可靠服务。其核心组成部分包括对多种接入协议的适配能力（如GB/T 28181、厂商私有SDK、API等）和流媒体处理能力，本 文档重点详述其面向运营管理的“接入平台管理”、“设备管理”和“通道管理”三大功能。

## 2. 用户与场景

- 2.1 目标用户: 省级适配中心系统管理员、运维工程师、技术支持人员。
- 2.2 用户场景/故事:
    - 场景一：作为一个省级适配中心系统管理员，我想要在系统中方便地配置和管理需要接入的各个省级视频平台（如千里眼、移动看家），包括其IP地址、认证信息和协议类型，并能测试连接状态，以便快速完成新平台的纳管。
    - 场景二：作为一个省级适配中心运维工程师，我需要统一查看和管理所有通过各省级平台接入的视频设备信息，包括其在线状态、厂商型号、所属区域等，并能对设备进行远程操作（如重启），以便于日常监控和维护。
    - 场景三：作为一个省级适配中心技术支持人员，当需要排查特定摄像头问题时，我希望能快速查询到该摄像头的详细信息，如编码格式、分辨率、当前状态，并能对其进行启用或停用操作，以便于故障诊断和管理。
    - 场景四：作为一个省级适配中心系统管理员，当某个省级平台的接入参数（如IP地址、认证Token）发生变更时，我希望能及时在适配中心更新这些配置，以保证数据同步和业务调用的连续性。

## 3. 功能范围/列表

- 3.1 功能模块一: 接入平台管理
- 3.2 功能模块二: 设备管理
- 3.3 功能模块三: 通道管理

## 4. 功能模块详情

---

### 4.1 功能模块：接入平台管理

#### 4.1.1 功能描述与目标

- 解决的问题: 需要一个统一的用户界面来配置和管理适配中心需要对接的各种省级视频平台实例，包括其连接参数、认证信息和协议规范，并能监控其基本可用性。 
    
- 用户价值/目标: 实现对多源异构省级视频平台的便捷、规范化接入配置与生命周期管理，确保适配中心能够成功连接并与之进行数据和信令交互，为后续的设备和业务适配奠定基础。
- 核心能力概述: 提供用户界面，用于配置和管理需要对接到适配中心的各省级视频平台实例。主要信息包括：平台名称、平台类型（如千里眼、移动看家、GB/T 28181国标域等）、厂商信息、接入协议版本、IP地址或域名、端口号、认证所需的用户名/密码/Token/证书等，并能测试连接状态。支持平台的增、删、改、查以及启/停用操作。 
    

#### 4.1.2 原型参考

- 主要原型页面: P01_Platform_List (接入平台列表页), P02_Platform_Add (新增接入平台弹窗), P03_Platform_Edit (编辑接入平台弹窗), P04_Platform_Detail (接入平台详情对话框)

#### 4.1.3 详细需求

##### 4.1.3.1 功能入口与触发条件

- 入口: 接口适配 -> 接入平台管理 [参考原型 P01_Platform_List]
- 触发条件: 用户已登录，并拥有“接入平台管理”功能的操作权限。

##### 4.1.3.2 交互流程与界面详述

- **A. 接入平台列表与查询**: [参考原型 P01_Platform_List]
    - 布局: 顶部为操作区（“新增平台”按钮、搜索框），下方为已配置的接入平台列表。
    - 包含元素:
        - 搜索框: 支持按平台名称、平台类型、厂商、IP地址、接入协议进行模糊搜索。
        - “新增平台”按钮。
        - 平台列表: 表格形式展示。关键列包括：选择框、序号、平台名称、平台类型、厂商、IP地址、端口、接入协议、状态（启用/禁用）、连接状态（已连接/未连接/连接中/认证失败/未测试）、创建时间。操作列包含：编辑、删除、详情、启用/禁用、测试连接等按钮。
    - 默认交互/排序: 列表默认按创建时间降序排列。支持点击列头对特定列进行排序。提供分页。
- **B. 新增接入平台**: [参考原型 P02_Platform_Add]
    - 触发: 在平台列表页面点击“新增平台”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“新增接入平台”模态对话框。
        - Step 2: 用户在表单中输入平台信息：平台名称（必填）、平台类型（必填，下拉选择）、厂商（可选）、IP地址（必填）、端口号（必填）、接入协议（必填，下拉选择）、用户名（可选）、密码（可选）、Token（可选）、备注（可选）。
        - Step 3: 用户点击“确定”按钮。
        - Step 4: 前端对必填项和数据格式（如IP、端口）进行校验。
        - Step 5: 后端对平台名称的唯一性等进行校验。
        - Step 6: 结果处理:
            - 成功保存: 关闭对话框，显示全局成功提示“新增接入平台 [平台名称] 成功”，平台列表刷新。
            - 失败 (业务校验/保存失败): 在对话框内或页面顶部显示具体的错误提示信息。
        - Step 7: 用户点击“取消”按钮或关闭对话框，则不保存任何信息。
- **C. 修改接入平台**: [参考原型 P03_Platform_Edit]
    - 触发: 在平台列表的操作列中点击对应平台的“编辑”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“编辑接入平台”模态对话框，并回填该平台的现有配置信息。
        - Step 2: 用户修改允许编辑的平台信息：平台名称、平台类型、厂商、IP地址、端口、接入协议、用户名、密码、Token、备注。平台ID为只读。
        - Step 3: 用户点击“确定”按钮。
        - Step 4: 前后端进行与新增平台时类似的校验。
        - Step 5: 结果处理同新增平台。
- **D. 查看接入平台详情**: [参考原型 P04_Platform_Detail]
    - 触发: 在平台列表的操作列中点击对应平台的“详情”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“接入平台详情”模态对话框。
        - Step 2: 展示该平台的所有信息，均为只读：平台ID、平台名称、平台类型、厂商、IP地址、端口、接入协议、用户名、密码、Token、状态、连接状态、创建时间、备注。
        - Step 3: 用户点击“关闭”按钮或关闭对话框。
- **E. 删除接入平台**: 
    - 触发: 在平台列表的操作列中点击对应平台的“删除”按钮。
    - 交互步骤:
        - Step 1: 系统弹出二次确认对话框：“确定删除接入平台 [平台名称] 吗？删除后，该平台下的所有设备和通道信息也将被移除或解绑（需明确具体处理逻辑）。”
        - Step 2: 用户点击“确定删除”按钮。
        - Step 3: 后端校验该平台是否仍有正在运行的业务依赖或未完成的数据同步任务。若有，则可能提示用户先处理这些依赖。
        - Step 4: 若允许删除，后端执行删除操作，包括清除平台配置信息、关联的设备/通道数据（或将其标记为孤立），并停止与该平台的所有交互。
        - Step 5: 结果处理:
            - 成功: 关闭确认对话框，显示全局成功提示“接入平台 [平台名称] 已被删除”，平台列表刷新。
            - 失败: 提示具体的错误信息。
- **F. 启用/停用接入平台**: 
    - 触发: 在平台列表的操作列中点击对应平台的“启用”或“停用”按钮。
    - 交互步骤:
        - Step 1: 系统根据当前状态弹出确认对话框：“确定[启用/停用]接入平台 [平台名称] 吗？”
        - Step 2: 用户点击“确定”。
        - Step 3: 后端更新平台的启用状态。若停用，则适配中心应停止与该平台的所有主动连接、数据同步和心跳维持等活动。若启用，则开始尝试连接和交互。
        - Step 4: 结果处理: 成功则更新列表中的状态，并提示操作成功。
- **G. 测试连接状态**: 
    - 触发: 在平台列表的操作列中点击“测试连接”按钮，或在新增/编辑平台时附带测试。 
        
    - 交互步骤:
        - Step 1: 用户点击“测试连接”。
        - Step 2: 后端根据该平台的配置信息（IP、端口、认证参数等）尝试与目标平台建立网络连接并进行应用层（如协议认证）的有效性验证。
        - Step 3: 界面应有loading状态提示“正在测试连接...”。
        - Step 4: 测试完成后，无论成功与否，都在界面上给出明确的反馈信息，如“连接成功，认证通过！”或“连接失败：无法访问目标主机”、“连接失败：认证信息错误（[具体错误码或原因]）”。同时更新该平台在列表中的“连接状态”显示。

##### 4.1.3.3 字段定义与数据规则

|   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|
|**字段名称**|**字段标识 (Eng)**|**数据类型 & 长度**|**界面显隐/读写**|**约束/规则 (强调唯一性、格式、范围、必填、默认值、选项来源)**|**数据来源/去向**|**备注/说明**|
|平台内部ID|platformInternalId|Long|隐藏/只读|系统自动生成，唯一|系统生成|主键|
|平台名称|platformName|String(100)|显示/读写|必填，适配中心内唯一|用户输入||
|平台类型|platformType|Enum(XUNLIYAN, YIDONG_KANJIA, GB28181, HIK_SDK, DAHUA_SDK, OTHER_API)|显示/读写|必填。选项来源为系统预定义枚举。|用户选择|如千里眼、移动看家、GB/T 28181国标域等|
|厂商信息|manufacturerInfo|String(100)|显示/读写|可选|用户输入||
|接入协议|protocol|String(50)|显示/读写|必填，下拉选择，如GB/T28181, SDK, API|用户选择||
|IP地址/域名|hostAddress|String(255)|显示/读写|必填，有效的IP地址或域名格式|用户输入||
|端口号|port|Integer|显示/读写|必填，1-65535|用户输入||
|用户名|username|String(100)|显示/读写|可选|用户输入||
|密码|password|String(100)|显示/读写|可选|用户输入|存储时应加密|
|Token|token|String(1000)|显示/读写|可选|用户输入||
|状态|status|Enum(ENABLED, DISABLED)|显示/读写（通过启/停用操作）|默认为ENABLED (启用)|用户操作/系统默认||
|连接状态|connectionStatus|Enum(CONNECTED, DISCONNECTED, CONNECTING, AUTH_FAIL, UNTESTED)|列表显示/只读||系统通过测试连接或心跳判断更新||
|创建时间|creationTime|DateTime|列表显示/只读|系统自动生成|系统生成||
|最后修改时间|lastUpdateTime|DateTime|隐藏/只读|系统自动更新|系统更新||

##### 4.1.3.4 权限控制

- 查看接入平台列表/详情: 需要具备“接入平台管理-查看”权限。
- 新增接入平台: 需要具备“接入平台管理-新增”权限。
- 修改接入平台信息: 需要具备“接入平台管理-修改”权限。
- 删除接入平台: 需要具备“接入平台管理-删除”权限。
- 启/停用接入平台: 需要具备“接入平台管理-启停”权限。
- 执行连接测试: 通常与查看或修改权限绑定，或单独设为“接入平台管理-测试”权限。

#### 4.1.4 业务规则

- 平台名称在适配中心内必须唯一。
- 不同平台类型对应不同的认证信息字段和协议参数配置。界面应动态适应。
- 停用一个接入平台意味着适配中心将不再尝试连接该平台、不再同步其数据、不再处理其上报的设备状态或告警等。所有与该平台相关的南向交互均暂停。
- 删除一个接入平台是不可逆操作，将清除该平台的所有配置信息。关联的设备和通道数据应明确处理策略（如同时删除、标记为孤立待处理、或禁止删除若仍有设备关联）。
- 连接状态的判断依据：优先通过“测试连接”功能的主动探测结果；对于已连接的平台，还可依赖协议层的心跳机制或定期数据交互的成功与否来更新。

#### 4.1.5 异常处理方案

- 新增/修改时平台名称已存在: 提示“平台名称 [具体名称] 已被使用，请更换”。
- IP地址/域名或端口号格式错误: 前端实时校验并提示。
- 测试连接失败: 明确提示失败的具体原因，如“无法访问目标主机：[IP:Port]”、“认证失败：用户名或密码错误”、“协议协商失败”等。
- 删除平台时有关联依赖: 若平台下仍有大量设备或正在进行的业务，应提示用户风险或先处理依赖。
- 启用已配置错误或无法访问的平台: 允许启用操作，但连接状态会显示为失败，并记录尝试连接的错误日志。

#### 4.1.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 南向协议适配引擎: 本模块配置的参数直接用于驱动协议适配引擎与各省级平台进行交互。
    - 系统预定义的平台类型和协议库: 为平台类型选择提供选项。
- **被依赖项 (Generated Dependencies)**:
    - 设备管理模块: 设备的注册和信息同步依赖于已成功配置并连接的接入平台。
    - 通道管理模块: 通道信息隶属于特定设备，间接依赖接入平台。
    - 省级平台连接状态监控 (驾驶舱内): 展示本模块管理的各平台的连接状态。
    - 业务数据采集模块: 从已连接的平台采集业务数据。
    - 审计日志模块: 记录所有接入平台配置的增删改启停等操作。

---

### 4.2 功能模块：设备管理

#### 4.2.1 功能描述与目标

- 解决的问题: 需要对所有通过南向协议适配从各省级平台自动同步发现的，或在特殊情况下手动注册的视频设备进行统一的视图展示、信息管理、状态监控和基本控制。 
    
- 用户价值/目标: 实现对多源异构省级设备的集中化、规范化管理，为运维人员提供便捷的设备查询、状态监控和远程维护手段，保障设备资源的可用性和可靠性。
- 核心能力概述: 对通过南向协议适配从各省级平台同步或手动注册的视频设备进行统一管理。内容包括：设备唯一ID（全局或平台内）、设备名称、厂商、型号、序列号、IP地址、所属接入平台、行政区域归属、GPS位置（可选）、当前状态（在线/离线/故障）等。支持按条件查询设备、查看设备详情、编辑设备补充信息（如自定义标签、备注）、远程控制（如重启，需平台支持）。 
    

#### 4.2.2 原型参考

- 主要原型页面: P05_Device_List (设备列表页), P06_Device_Detail (设备详情对话框), P07_Device_Edit_Supp (编辑设备补充信息对话框), P10_Device_Add_Manual (手动添加设备对话框)

#### 4.2.3 详细需求

##### 4.2.3.1 功能入口与触发条件

- 入口: 接口适配 -> 设备管理 [参考原型 P05_Device_List]
- 触发条件: 用户已登录，并拥有“设备管理”功能的操作权限。

##### 4.2.3.2 交互流程与界面详述

- **A. 设备列表与查询**: [参考原型 P05_Device_List]
    - 布局: 顶部为筛选条件区和操作区（“手动添加设备”按钮），下方为设备列表。
    - 包含元素:
        - 筛选器: 支持按设备ID、设备名称、所属平台、厂商、型号、IP地址、行政区域、状态（在线/离线/故障/未激活）进行组合查询。
        - “手动添加设备”按钮。
        - 设备列表: 表格形式展示。关键列包括：选择框、序号、设备ID、设备名称、所属平台、厂商、型号、IP地址、端口、行政区域、状态、创建时间。操作列包含：详情、编辑补充信息、查看通道、远程重启等按钮。
    - 默认交互/排序: 列表默认按创建时间降序排列。支持点击列头排序。提供分页。
    - 注册来源标识: 列表中应有字段或图标清晰标识设备是“平台同步”还是“手动添加”。
- **B. 查看设备详情**: [参考原型 P06_Device_Detail]
    - 触发: 点击设备列表操作列中的“详情”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“设备详情”模态对话框。
        - Step 2: 展示设备的所有已知信息，均为只读。包含页签：基本信息（设备ID、设备名称、所属平台、厂商、型号、序列号、IP地址、端口、行政区域、GPS经纬度、状态、创建时间、注册来源）、标签信息、备注信息。
        - Step 3: 用户点击“关闭”按钮或关闭对话框。
        - Step 2: 详细展示设备的所有已知信息，包括基础信息（ID、名称、厂商、型号、序列号、IP地址、所属平台、区域、GPS 13 等）、实时状态信息（在线/离线/故障、CPU/内存使用率 - 若平台支持获取）、补充信息（自定义标签、备注 14）、关联的通道列表（可点击跳转）、设备操作日志等。大部分信息通常为只读（源自平台同步）。
            
- **C. 编辑设备补充信息**: [参考原型 P07_Device_Edit_Supp]
    - 触发: 在设备列表操作列中点击“编辑补充信息”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“编辑设备补充信息”模态对话框。
        - Step 2: 用户可以编辑：“自定义标签”（可多个，支持增删）、“备注信息”、“安装位置”、“维护责任人”。设备ID为只读。
        - Step 3: 用户点击“确定”按钮。
        - Step 4: 后端保存这些补充信息，并与设备主信息关联。
        - Step 5: 成功则关闭对话框，提示“补充信息保存成功”，并刷新列表或详情中的对应信息。
        - Step 6: 用户点击“取消”按钮或关闭对话框，则不保存任何信息。
- **D. 远程控制设备 (如重启)**:
    - 触发: 在设备列表操作列中点击“远程重启”按钮。
    - 交互步骤:
        - Step 1: 系统弹出二次确认对话框：“确定要对设备 [设备名称/ID] 执行远程重启操作吗？此操作可能导致设备短暂离线。”
        - Step 2: 用户点击“确定”。
        - Step 3: 后端通过对应的南向协议适配模块，向该设备所属的省级平台发送远程控制指令。前提是该省级平台及其接入协议支持此类远程控制。
        - Step 4: 界面提示“远程重启指令已发送，请稍后关注设备状态。”。操作结果（成功/失败/不支持）依赖于平台和设备的反馈，适配中心应尝试获取并记录该结果。
        - Step 5: （可选）系统可轮询设备状态，在指令执行后一段时间内更新其在线状态。
- **E. 手动添加设备**: [参考原型 P10_Device_Add_Manual]
    - 触发: 在设备列表页面点击“手动添加设备”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“手动添加设备”模态对话框。
        - Step 2: 用户在表单中输入设备信息：设备ID（必填）、设备名称（必填）、所属平台（必填，下拉选择已配置的接入平台）、厂商（可选）、型号（可选）、序列号（可选）、IP地址（必填）、端口号（必填）、行政区域（可选）、GPS经度（可选）、GPS纬度（可选）、安装位置（可选）、维护责任人（可选）、备注（可选）。
        - Step 3: 用户点击“确定”按钮。
        - Step 4: 前端对必填项和数据格式进行校验。
        - Step 5: 后端对设备ID在所属平台下的唯一性等进行校验。
        - Step 6: 结果处理:
            - 成功保存: 关闭对话框，显示全局成功提示“手动添加设备 [设备名称] 成功”，设备列表刷新。
            - 失败 (业务校验/保存失败): 在对话框内或页面顶部显示具体的错误提示信息。
        - Step 7: 用户点击“取消”按钮或关闭对话框，则不保存任何信息。
    - 系统支持手动补充录入无法通过平台自动同步的设备。
    - 交互类似于新增接入平台，需填写设备关键信息，并关联到一个已配置的“接入平台”（即使该平台可能无法直接发现此设备，但逻辑上仍需归属）。手动注册的设备状态可能需要人工维护或依赖有限的探测手段。

##### 4.1.3.3 字段定义与数据规则

|   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|
|**字段名称**|**字段标识 (Eng)**|**数据类型 & 长度**|**界面显隐/读写**|**约束/规则 (强调唯一性、格式、范围、必填、默认值、选项来源)**|**数据来源/去向**|**备注/说明**|
|设备内部ID|deviceInternalId|Long|隐藏/只读|系统自动生成，唯一|系统生成|主键|
|设备ID (业务)|deviceBusinessId|String(100)|显示/读写（手动添加时可写）|必填。在所属接入平台内唯一，或配置为全局唯一。|省级平台同步/手动输入|如国标ID|
|设备名称|deviceName|String(100)|显示/读写（手动添加时可写，补充信息可编辑名称）|必填|省级平台同步/用户可修改||
|所属接入平台内码|platformInternalId|Long|隐藏/关联|必填|系统关联|外键关联接入平台表|
|所属接入平台名称|platformName|String(100)|列表显示/只读||冗余接入平台名称||
|厂商|manufacturer|String(50)|显示/只读（平台同步时）||省级平台同步||
|型号|model|String(50)|显示/只读（平台同步时）||省级平台同步||
|序列号|serialNumber|String(100)|显示/只读（平台同步时）||省级平台同步||
|IP地址|ipAddress|String(45)|显示/读写（手动添加时可写）||省级平台同步/手动输入|IPv4或IPv6|
|端口|port|Integer|显示/读写（手动添加时可写）|1-65535|省级平台同步/手动输入||
|行政区域归属|administrativeRegion|String(100)|显示/读写（手动添加或补充信息可编辑）||省级平台同步/用户补充|如省/市/区/街道|
|GPS经度|gpsLongitude|Double|显示/读写（手动添加或补充信息可编辑）|可选，-180 to 180|省级平台同步/用户补充||
|GPS纬度|gpsLatitude|Double|显示/读写（手动添加或补充信息可编辑）|可选，-90 to 90|省级平台同步/用户补充||
|状态|currentStatus|Enum(ONLINE, OFFLINE, FAULTY, UNACTIVATED, UNKNOWN)|显示/只读||省级平台同步/心跳检测|在线、离线、故障、未激活、未知|
|最近在线时间|lastOnlineTime|DateTime|列表显示/只读||系统记录/平台同步||
|自定义标签|customTags|List&lt;String>|详情显示/补充信息可编辑|可选|用户输入||
|备注|remarks|String(500)|详情显示/补充信息或手动添加可编辑|可选|用户输入||
|安装位置|installationLocation|String(200)|详情显示/补充信息或手动添加可编辑|可选|用户输入||
|维护责任人|maintenanceContact|String(50)|详情显示/补充信息或手动添加可编辑|可选|用户输入||
|注册来源|registrationSource|Enum(PLATFORM_SYNC, MANUAL_ADD)|列表显示/只读||系统记录|平台同步/手动添加|
|创建时间|creationTime|DateTime|隐藏/只读|系统自动生成|系统生成||
|最后更新时间 (平台同步)|lastSyncTime|DateTime|隐藏/只读||平台同步时更新||

##### 4.1.3.4 权限控制

- 查看设备列表/详情: 需要具备“设备管理-查看”权限。
- 编辑设备补充信息: 需要具备“设备管理-编辑补充信息”权限。
- 执行设备远程控制: 需要具备“设备管理-远程控制”权限，并可能根据具体控制命令的危险级别细化。
- 手动注册/删除设备: 需要特定高级权限，如“设备管理-手动操作”。

#### 4.2.4 业务规则

- 设备信息主要通过关联的接入平台进行同步（如GB/T 28181的设备目录获取，或厂商SDK的设备列表查询）。适配中心定期或按需从各启用平台拉取最新设备列表及状态。
- 设备唯一ID（业务层面）的确定：对于国标设备，通常使用其国标ID。对于非国标设备，需依赖其在所属平台内的唯一标识，适配中心在存储时可结合平台ID保证全局唯一性（若需）。
- 设备状态的更新：主要依赖于省级平台推送的设备状态变更通知，或适配中心通过协议心跳、主动轮询等方式获取。
- 编辑补充信息：用户在适配中心为设备添加的标签、备注等信息，存储在适配中心本地，不回写到源省级平台。当设备从源平台被删除并重新同步时，这些补充信息可能会丢失，除非有特定保留机制。
- 远程控制的可用性：取决于具体设备型号、其所属省级平台的接入协议是否支持相应的控制命令，以及适配中心的南向协议适配模块是否已实现该命令的转换和下发。操作结果也依赖平台和设备反馈。

#### 4.2.5 异常处理方案

- 设备状态长时间未知或无法同步: 应在界面上明确标示，并可配置告警通知运维人员。
- 编辑补充信息保存失败: 提示用户具体原因（如数据库错误、输入内容超长等）。
- 远程控制指令发送失败/无响应: 明确告知用户指令已尝试发送，但执行结果未知或失败，并记录相关日志。若平台明确返回“不支持此操作”，则应提示用户。
- 查询无结果: 列表为空时，友好提示“未找到符合条件的设备”。

#### 4.2.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 接入平台管理模块: 设备必须归属于一个已配置的接入平台，其信息和状态的获取依赖于该平台的连接和协议适配。
    - 南向协议适配引擎: 负责实际与设备（或通过其上级平台）进行通信，获取信息和下发指令。
- **被依赖项 (Generated Dependencies)**:
    - 通道管理模块: 通道信息隶属于本模块管理的设备。
    - 客户授权资源管理模块: 客户可被授权访问本模块管理的特定设备。
    - 设备分析模块 (运营分析): 基于本模块的设备数据进行统计分析。
    - 驾驶舱模块: 展示设备总数、在线率等概览信息。
    - 告警管理模块: 接收和处理与设备状态相关的告警（如设备离线、故障）。
    - 审计日志模块: 记录设备信息的变更、远程控制操作等。

---

### 4.3 功能模块：通道管理

#### 4.3.1 功能描述与目标

- 解决的问题: 对于已纳管的视频设备，需要进一步对其下的具体媒体通道（如摄像头视频流、音频流、报警量等）进行统一的列表展示、信息查看和状态管理。 
    
- 用户价值/目标: 提供对设备下属通道资源的精细化管理能力，确保运营和运维人员能够清晰了解每个通道的属性、状态，并能进行必要的启停控制，为视频业务的正常开展提供保障。
- 核心能力概述: 统一管理隶属于已纳管省级设备下的视频通道（摄像头）、音频通道、报警输入/输出通道等。内容包括：通道唯一ID、通道名称、通道类型、所属设备ID、编码格式（H.264/H.265等）、分辨率、帧率、码率、当前状态等。支持查询、查看详情、编辑通道备注信息、启/停用通道（需平台支持）。 
    

#### 4.3.2 原型参考

- 主要原型页面: P08_Channel_List (某设备下的通道列表页), P09_Channel_Detail (通道详情对话框), P09_Channel_Edit_Remark (编辑通道备注对话框), P11_Channel_Add_Manual (手动添加通道对话框)

#### 4.3.3 详细需求

##### 4.3.3.1 功能入口与触发条件

- 入口1: 设备管理 -> 设备列表 -> 某设备的操作列“查看通道”按钮，进入该设备下的通道列表。 [参考原型 P08_Channel_List]
- 入口2: (可选) 接口适配 -> 通道管理（全局通道列表，需支持按设备筛选）。
- 触发条件: 用户已登录，并拥有“通道管理”功能的操作权限。

##### 4.3.3.2 交互流程与界面详述

- **A. 通道列表与查询**: [参考原型 P08_Channel_List]
    - 布局: 顶部为设备信息概要（当从特定设备进入时）和操作区（“手动添加通道”按钮、返回设备列表按钮），下方为通道列表。
    - 包含元素:
        - （可选，若支持全局通道列表）筛选器: 支持按通道ID、通道名称、所属设备、通道类型、状态（在线/离线/故障/未激活）进行组合查询。
        - “手动添加通道”按钮。
        - 通道列表: 表格形式展示。关键列包括：选择框、序号、通道ID、通道名称、通道类型、状态、编码格式、分辨率、帧率、码率、是否支持PTZ。操作列包含：详情、编辑备注、启用/禁用等按钮。
    - 默认交互/排序: 列表默认按通道ID排序。支持点击列头排序。提供分页。
- **B. 查看通道详情**: [参考原型 P09_Channel_Detail]
    - 触发: 点击通道列表操作列中的“详情”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“通道详情”模态对话框。
        - Step 2: 详细展示通道的所有已知信息，均为只读：通道ID、通道名称、所属设备、通道类型、状态、编码格式、分辨率、帧率、码率、码流类型、是否支持PTZ、备注。
        - Step 3: 用户点击“关闭”按钮或关闭对话框。
            
- **C. 编辑通道备注信息**: [参考原型 P09_Channel_Edit_Remark]
    - 触发: 在通道列表操作列中点击“编辑备注”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“编辑通道备注”模态对话框。
        - Step 2: 用户可以编辑该通道的“备注”信息字段。通道ID为只读。
        - Step 3: 用户点击“确定”按钮。
        - Step 4: 后端保存备注信息，并与通道关联。
        - Step 5: 成功则关闭对话框，提示“通道备注保存成功”，并刷新列表中的对应信息。
        - Step 6: 用户点击“取消”按钮或关闭对话框，则不保存任何信息。
- **D. 手动添加通道**: [参考原型 P11_Channel_Add_Manual]
    - 触发: 在特定设备的通道列表页面点击“手动添加通道”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“手动添加通道”模态对话框。
        - Step 2: 用户在表单中输入通道信息：通道ID（必填）、通道名称（必填）、所属设备（只读，自动填充当前设备信息）、通道类型（必填，下拉选择）、编码格式（可选）、分辨率（可选）、帧率（可选）、码率（可选）、是否支持PTZ（可选，是/否）、备注（可选）。
        - Step 3: 用户点击“确定”按钮。
        - Step 4: 前端对必填项进行校验。
        - Step 5: 后端对通道ID在所属设备下的唯一性等进行校验。
        - Step 6: 结果处理:
            - 成功保存: 关闭对话框，显示全局成功提示“手动添加通道 [通道名称] 成功”，通道列表刷新。
            - 失败 (业务校验/保存失败): 在对话框内或页面顶部显示具体的错误提示信息。
        - Step 7: 用户点击“取消”按钮或关闭对话框，则不保存任何信息。
- **E. 启用/停用通道**: 
    - 触发: 在通道列表操作列或通道详情页点击“启用”或“停用”按钮（此功能需省级平台及设备协议支持）。 
        
    - 交互步骤:
        - Step 1: 用户点击操作按钮。
        - Step 2: 系统弹出二次确认对话框：“确定要[启用/停用]通道 [通道名称/ID] 吗？”
        - Step 3: 用户点击“确定”。
        - Step 4: 后端通过对应的南向协议适配模块，向该通道所属的设备（或其上级平台）发送启/停用通道的指令。
        - Step 5: 界面提示“指令已发送，请稍后关注通道状态。”。操作结果（成功/失败/不支持）依赖平台和设备反馈。
        - Step 6: 若操作成功，通道列表中的状态应相应更新。

##### 4.1.3.3 字段定义与数据规则

|   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|
|**字段名称**|**字段标识 (Eng)**|**数据类型 & 长度**|**界面显隐/读写**|**约束/规则 (强调唯一性、格式、范围、必填、默认值、选项来源)**|**数据来源/去向**|**备注/说明**|
|通道内部ID|channelInternalId|Long|隐藏/只读|系统自动生成，唯一|系统生成|主键|
|通道ID (业务)|channelBusinessId|String(100)|显示/读写（手动添加时可写）|必填。在所属设备内唯一。|省级平台同步/手动输入|如国标通道ID|
|通道名称|channelName|String(100)|显示/读写（手动添加时可写）|必填|省级平台同步/手动输入||
|所属设备内部ID|deviceInternalId|Long|隐藏/关联|必填|系统关联|外键关联设备表|
|所属设备业务ID|deviceBusinessId|String(100)|列表显示/只读||冗余设备业务ID||
|通道类型|channelType|Enum(VIDEO_INPUT, AUDIO_INPUT, ALARM_INPUT, ALARM_OUTPUT)|显示/读写（手动添加时可写）|必填|省级平台同步/手动输入|视频输入、音频输入、报警输入、报警输出等|
|状态|currentStatus|Enum(ONLINE, OFFLINE, FAULTY, UNACTIVATED, UNKNOWN)|显示/只读||省级平台同步/协议交互获取|在线、离线、故障、未激活、未知|
|编码格式|encodingFormat|String(20)|视频通道显示/读写（手动添加时可写）||省级平台同步/手动输入|如H.264, H.265, MPEG4|
|分辨率|resolution|String(20)|视频通道显示/读写（手动添加时可写）||省级平台同步/手动输入|如1920x1080, 1280x720|
|帧率 (fps)|frameRate|Integer|视频通道显示/读写（手动添加时可写）||省级平台同步/手动输入||
|码率 (Kbps)|bitRate|Integer|视频通道显示/读写（手动添加时可写）||省级平台同步/手动输入||
|码流类型|streamType|Enum(MAIN_STREAM, SUB_STREAM, THIRD_STREAM)|视频通道显示/只读||省级平台同步|主码流、子码流、第三码流|
|是否支持PTZ|ptzSupport|Boolean|视频通道显示/读写（手动添加时可写）|默认为false|省级平台同步/手动输入||
|备注|remarks|String(500)|详情显示/可编辑（手动添加或编辑备注时可写）|可选|用户输入||
|创建时间|creationTime|DateTime|隐藏/只读|系统自动生成|系统生成||
|最后更新时间 (平台同步)|lastSyncTime|DateTime|隐藏/只读||平台同步时更新||

##### 4.1.3.4 权限控制

- 查看通道列表/详情: 需要具备“通道管理-查看”权限。
- 编辑通道备注信息: 需要具备“通道管理-编辑备注”权限。
- 启/停用通道: 需要具备“通道管理-启停控制”权限。

#### 4.3.4 业务规则

- 通道信息主要通过其所属设备从对应的接入平台同步获取（如GB/T 28181的设备目录查询结果中包含通道列表）。
- 通道唯一ID（业务层面）通常是在其所属设备内的唯一编号。
- 通道状态的准确性依赖于省级平台和设备的实时反馈能力。
- 启/停用通道操作的成功与否及实际效果，完全取决于底层设备和平台是否支持此功能。适配中心仅负责转发指令和（尽可能）获取反馈。
- 通道备注信息存储在适配中心本地，不回写到源设备或平台。

#### 4.3.5 异常处理方案

- 获取通道列表失败或通道信息不完整: 界面应有相应提示，并记录错误日志。
- 启/停用指令发送失败/无响应/设备不支持: 明确告知用户指令发送情况及可能的设备限制。
- 查询无结果: 列表为空时，友好提示“未找到符合条件的通道”或“该设备下暂无通道信息”。

#### 4.3.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 设备管理模块: 通道必须隶属于一个已在适配中心纳管的设备。通道信息的获取和管理都基于其父设备。
    - 南向协议适配引擎: 负责与设备（或通过其上级平台）进行通信，获取通道详细信息和下发启停指令。
- **被依赖项 (Generated Dependencies)**:
    - （省侧）流媒体处理与转发模块: 需要根据本模块管理的通道信息（如编码格式、码流类型）来正确拉取和处理视频流。
    - 客户授权资源管理模块: 客户可被授权访问本模块管理的特定通道。
    - 视频业务模块（如实时预览、录像回放）: 业务操作直接作用于具体的通道。
    - 审计日志模块: 记录通道信息查看、备注修改、启停控制等操作。