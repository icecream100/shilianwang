# 需求文档 - 业务数据采集与配置管理

## 1. 功能概述

- 1.1 功能名称：业务数据采集与配置管理
- 1.2 功能概述：本模块负责配置、执行并监控从各类外部数据源（包括已对接的省级视频业务平台、省侧CRM系统）的数据采集任务，以及适配中心自身运行状态数据的收集。其核心目标是确保准确、及时地获取运营分析、业务监控及平台运维所需的各类原始数据，并为这些数据的采集过程提供灵活的配置管理和状态展现能力。

## 2. 用户与场景

- 2.1 目标用户: 省级适配中心系统管理员、运维工程师、数据分析配置人员。
- 2.2 用户场景/故事:
    - 场景一：作为一个省级适配中心系统管理员，我希望能配置从各个已接入的省级视频平台（如千里眼）定期采集其设备元数据、用户访问行为以及视频业务统计数据，以便为后续的运营分析提供数据基础。
    - 场景二：作为一个省级适配中心数据对接负责人，我需要配置与省侧CRM系统的接口参数、字段映射和同步频率，以确保客户信息能够准确、自动地同步到适配中心，支持客户管理和客户分析功能。
    - 场景三：作为一个省级适配中心运维工程师，我需要一个集中的界面来实时查看数据同步任务的执行情况，以便快速发现和定位潜在的运行问题。
    - 场景四：作为一个省级适配中心系统管理员，当某个省级视频平台的数据接口发生变更或新增了可采集的数据类型时，我希望能方便地修改对应的数据采集任务配置，以适应这些变化。

## 3. 功能范围/列表

- 3.1 功能模块一: 运行业务数据采集配置
- 3.2 功能模块二: CRM客户数据同步配置
- 3.3 功能模块三: 任务状态

## 4. 功能模块详情

---

### 4.1 功能模块：运行业务数据采集配置

#### 4.1.1 功能描述与目标

- 解决的问题: 需要一个配置界面来管理从已对接的各省级视频平台（如千里眼、移动看家）采集特定业务数据的任务，明确采集内容、频率和方式。
- 用户价值/目标: 实现对省级视频平台各类运行数据的按需、可配置化采集，确保数据采集的全面性和准确性，为上层数据应用提供原始数据支撑。
- 核心能力概述: 通过南向接口适配模块，主动从已对接的省级视频平台（如千里眼、移动看家）定期或实时采集各类数据 1。包括：设备和通道的详细元数据（如型号、固件版本、安装位置、能力集等）；用户通过这些平台的访问行为数据（如登录次数、视频查看时长）；视频业务数据（如录像存储时长、智能分析事件触发次数）；以及平台自身的业务办理数据（如套餐订购信息，需平台开放接口） 2。本功能提供对这些采集任务的配置管理。
    

#### 4.1.2 原型参考

- 主要原型页面: P_DataColl_Biz_ConfigList (运行业务数据采集配置列表页), P_DataColl_Biz_AddEditConfig (新增/编辑运行业务数据采集配置页)

#### 4.1.3 详细需求

##### 4.1.3.1 功能入口与触发条件

- 入口: 运营门户模块 -> 数据管理 -> 运行业务数据采集配置 [参考原型 P_DataColl_Biz_ConfigList]
- 触发条件: 用户已登录，并拥有“运行业务数据采集配置”权限。

##### 4.1.3.2 交互流程与界面详述

- **A. 数据采集任务列表与筛选**: [参考原型 P_DataColl_Biz_ConfigList]
    - 布局: 顶部为“新增采集配置”按钮和筛选区域，下方为已配置的数据采集任务列表。
    - 包含元素:
        - 筛选器: 支持按源平台名称、数据类型（如设备元数据、用户行为数据、视频业务数据等）、采集频率、启用状态进行筛选。
        - “新增采集配置”按钮。
        - 列表: 表格形式展示。关键列包括：配置名称、源省级视频平台、采集数据类型、采集频率/方式（周期性/实时）、启用状态、上次执行时间、上次执行状态。操作列包含：编辑、删除、查看详情、启用/停用、手动触发一次。
    - 默认交互/排序: 列表默认按创建时间降序。
- **B. 新增/编辑运行业务数据采集配置**: [参考原型 P_DataColl_Biz_AddEditConfig]
    - 触发: 点击“新增采集配置”按钮或已有配置的“编辑”按钮。
    - 交互步骤:
        - Step 1: 系统弹出“运行业务数据采集配置”对话框/页面。
        - Step 2: 用户输入配置名称。
        - Step 3: 选择源省级视频平台（从已在“接入平台管理”中配置的平台列表选择）。
        - Step 4: 选择需要采集的数据类型/范围：
            - 以复选框或标签形式列出该类型平台通常支持采集的数据项（如设备元数据、通道元数据、用户访问日志、视频点播统计、录像存储信息、套餐订购信息等，需平台接口支持）。
            - 对于某些数据类型，可能需要配置更细致的参数（如特定事件的订阅、特定统计指标的名称等，若平台API支持）。
        - Step 5: 配置采集方式与频率：
            - 采集方式：选择“周期性拉取”或“实时/准实时订阅”（若平台支持事件通知）。
            - 采集频率：若为周期性拉取，则配置执行周期（如每小时、每日特定时间、自定义CRON表达式）。
        - Step 6: 选择是否立即启用该采集配置。
        - Step 7: 用户点击“保存”。
        - Step 8: 前后端校验配置的完整性和有效性。
        - Step 9: 成功则保存配置，刷新列表，提示成功；失败则提示错误。
- **C. 查看采集任务详情与状态**:
    - 触发: 点击配置列表中的“查看详情”或配置名称。
    - 交互: 展示配置的所有信息，以及近期的执行历史、成功/失败次数、采集到的数据量概要等。
- **D. 启用/停用采集任务**:
    - 触发: 点击配置列表中的“启用”或“停用”按钮。
    - 交互: 二次确认后，更新任务的启用状态。停用后，对应的采集活动将暂停。
- **E. 手动触发一次采集**:
    - 触发: 点击配置列表中的“手动触发一次”按钮。
    - 交互: 二次确认后，后台立即执行一次该配置定义的采集任务，并记录执行日志。

##### 4.1.3.3 字段定义与数据规则 (配置项)

|   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|
|**字段名称**|**字段标识 (Eng)**|**数据类型 & 长度**|**界面显隐/读写**|**约束/规则**|**数据来源/去向**|**备注/说明**|
|配置ID|configId|Long|隐藏/只读|系统生成|系统生成|主键|
|配置名称|configName|String(100)|显示/读写|必填，唯一|用户输入||
|源省级平台内码|sourcePlatformInternalId|Long|隐藏/关联|必填|用户从接入平台列表选择||
|源省级平台名称|sourcePlatformName|String(100)|显示/只读||关联显示||
|采集数据类型|dataTypesToCollect|List&lt;String>|显示/多选|必填，至少选一项。选项基于平台能力预定义。|用户选择|如：DEVICE_METADATA, CHANNEL_METADATA, USER_ACCESS_LOGS, VIDEO_STATS|
|采集参数|collectionParams|JSON/Text|显示/读写（高级）|可选，针对特定数据类型的细化参数|用户输入||
|采集方式|collectionMode|Enum(PERIODIC_PULL, REALTIME_SUBSCRIBE)|显示/选择|必填|用户选择||
|采集频率 (CRON)|collectionFrequencyCron|String(50)|若方式为PULL则显示/读写|条件性必填|用户输入/选择预设||
|启用状态|enabledStatus|Boolean|显示/读写|默认为true|用户选择||

##### 4.1.3.4 权限控制

- 查看/编辑/删除/启停用运行业务数据采集配置: 需要特定权限，如“运行业务数据采集配置管理”。
- 手动触发采集: 通常与编辑权限一致。

#### 4.1.4 业务规则

- 一个源省级平台可以有多个数据采集配置，分别针对不同类型的数据或不同频率。
- 采集的数据项和能力高度依赖于具体省级视频平台的接口开放程度和协议规范。配置界面应尽可能清晰地反映这些依赖。
- 采集到的原始数据应进行初步的格式化和校验，并存储到适配中心的原始数据层或数据湖中，供后续处理和分析。
- 采集任务的执行状态和结果（成功/失败、采集数据量等）需要被详细记录。

#### 4.1.5 异常处理方案

- 源平台接口不可达或认证失败: 采集任务执行时，若无法连接源平台或认证失败，应记录错误，标记任务执行失败，并可配置告警通知。
- 请求的数据类型平台不支持或无数据: 记录正常，但采集数据量为零或有特定提示。
- 数据解析或格式转换失败: 记录错误，尽可能不中断整个采集批次，标记问题数据。

#### 4.1.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 接入平台管理模块: 采集配置必须选择一个已成功配置并启用的省级视频平台。
    - 南向接口适配模块: 实际执行数据采集的动作依赖此模块的协议交互能力。
- **被依赖项 (Generated Dependencies)**:
    - 运营分析模块: 采集到的运行业务数据是进行设备分析、业务分析等的重要数据源。
    - 驾驶舱模块: 部分运营指标可能来源于此采集的数据。
    - （本模块下）任务状态: 可能展示这些采集任务的执行状态。

---

### 4.2 功能模块：CRM客户数据同步配置

#### 4.2.1 功能描述与目标

- 解决的问题: 需要一个标准化的方式来配置和管理与省侧CRM系统的数据对接，实现客户信息的自动同步，包括处理字段差异和数据格式转换。
- 用户价值/目标: 确保适配中心能够及时、准确地获取最新的客户基础信息，减少人工录入和信息不一致的风险，为客户管理、客户授权以及客户相关的运营分析提供可靠的数据基础。
- 核心能力概述: 提供专门的接口配置和管理功能，用于设定与省侧CRM（客户关系管理）系统的对接参数 3。包括CRM系统的API地址、认证方式、数据查询条件、同步频率（如每日一次）等 4。核心是支持客户数据字段的自定义映射规则和简单的数据转换逻辑（如代码值转换），确保CRM中的客户信息能准确同步至适配中心 5。
    

#### 4.2.2 原型参考

- 主要原型页面: P_DataColl_CRM_Config (CRM同步配置主页), P_DataColl_CRM_FieldMapping (CRM字段映射配置页), P_DataColl_CRM_SyncLog (CRM同步日志查看页)

#### 4.2.3 详细需求

##### 4.2.3.1 功能入口与触发条件

- 入口: 运营门户模块 -> 数据管理 -> CRM客户数据同步配置 [参考原型 P_DataColl_CRM_Config]
- 触发条件: 用户已登录，并拥有“CRM客户数据同步配置”权限。

##### 4.2.3.2 交互流程与界面详述

- **A. CRM同步配置主界面**: [参考原型 P_DataColl_CRM_Config]
    - 布局: 页面展示CRM对接的核心参数配置区域、字段映射配置入口、同步日志查看入口以及手动触发同步按钮。
    - CRM接口参数配置:
        - API服务地址: 输入CRM系统提供数据同步服务的API Endpoint URL。
        - 认证方式: 下拉选择（如OAuth2, API Key, Basic Auth等），并根据选择动态展示所需认证参数输入字段（如Client ID/Secret, Token URL, Key/Value, Username/Password）。
        - 数据查询条件 (可选): 若CRM接口支持按条件筛选客户数据（如仅同步特定状态或类型的客户），则提供配置界面（如输入OData filter, GraphQL query片段, 或键值对参数）。
        - 同步频率: 选择预设频率（如每小时、每日特定时间）或输入自定义CRON表达式。
        - 启用状态: 开关，控制是否启用CRM同步任务。
        - 测试连接按钮: 验证API地址和认证参数是否能成功连接CRM系统。
    - 操作按钮: “保存配置”、“字段映射与转换规则”、“查看同步日志”、“手动触发一次同步”。
- **B. 字段映射与转换规则配置**: [参考原型 P_DataColl_CRM_FieldMapping] (此部分与客户管理模块中的CRM字段映射配置类似，但此处是数据采集模块的一部分，专注于配置层面)
    - 触发: 在CRM同步配置主界面点击“字段映射与转换规则”按钮。
    - 交互:
        - 界面分两栏，左侧为CRM源系统字段（可手动输入或通过接口探测样例），右侧为适配中心客户信息目标字段（从适配中心客户数据模型中选择）。
        - 管理员建立源字段与目标字段的映射关系。
        - 对每个映射，可配置简单数据转换规则（如值到值的映射、日期格式化、字符串操作、默认值填充等）。
        - 保存映射与转换规则。
- **C. 查看同步日志**: [参考原型 P_DataColl_CRM_SyncLog] (此部分与客户管理模块中的CRM同步日志查看类似)
    - 触发: 在CRM同步配置主界面点击“查看同步日志”按钮。
    - 交互:
        - 列表展示历次同步任务的执行时间、状态（成功/失败/部分成功）、同步客户数量、新增/更新数量、失败详情。
        - 支持按日期、状态查询日志。可查看单条日志的详细错误信息。
- **D. 手动触发一次同步**:
    - 触发: 在CRM同步配置主界面点击“手动触发一次同步”按钮。
    - 交互: 二次确认后，后台立即执行一次CRM客户数据同步任务，结果记录在同步日志中。

##### 4.1.3.3 字段定义与数据规则 (配置项)

|   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|
|**字段名称**|**字段标识 (Eng)**|**数据类型 & 长度**|**界面显隐/读写**|**约束/规则**|**数据来源/去向**|**备注/说明**|
|CRM API地址|crmApiUrl|String(255)|显示/读写|必填，有效URL|管理员输入||
|CRM认证方式|crmAuthType|Enum|显示/选择|必填|管理员选择||
|CRM认证参数|crmAuthParams|JSON/Text|显示/读写|条件性必填|管理员输入||
|CRM数据查询条件|crmQueryFilter|String(500)|显示/读写|可选|管理员输入||
|CRM同步频率(CRON)|crmSyncFrequencyCron|String(50)|显示/读写|必填|管理员输入/选择预设||
|CRM字段映射规则|crmFieldMappingRules|JSON/Text|通过专用界面配置/内部存储|必填|管理员配置||
|CRM同步启用状态|crmSyncEnabled|Boolean|显示/读写|默认为true|管理员选择||

##### 4.1.3.4 权限控制

- 查看/编辑CRM客户数据同步配置、字段映射、手动触发同步、查看日志: 需要特定权限，如“CRM数据同步配置管理”。

#### 4.2.4 业务规则

- 同步来的CRM客户信息将作为适配中心内客户数据的主要来源或重要补充，用于客户管理、授权、分析等。
- 字段映射和转换规则的正确性对数据质量至关重要。应提供预览或测试功能（可选）。
- 同步冲突处理：若适配中心内已有手动创建的客户与CRM同步来的客户可识别为同一实体，需有明确的冲突解决策略（如CRM优先、提示人工合并等，此策略在客户管理模块中定义，此处配置保证同步）。
- 同步任务的健壮性：应能处理网络波动、CRM接口临时不可用等情况，支持重试机制。

#### 4.2.5 异常处理方案

- CRM接口连接/认证失败: 在“测试连接”或实际同步时，明确提示错误信息，记录日志，不更新数据。
- 字段映射配置错误或数据转换失败: 记录详细错误日志，标记受影响的客户数据，尽可能不中断整个同步批次。
- 同步过程中部分数据校验失败: 按条记录失败原因，整体任务可标记为“部分成功”。

#### 4.2.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 省侧CRM系统的API接口。
    - 适配中心客户信息的数据模型定义 (客户管理模块)。
- **被依赖项 (Generated Dependencies)**:
    - 客户信息管理模块: 同步的客户数据会写入此模块管理的数据表。
    - 运营分析模块 (客户分析): 以同步的CRM数据为重要分析数据源。
    - （本模块下）任务状态: 可能展示CRM同步任务的执行状态。

---

### 4.3 功能模块：任务状态

#### 4.3.1 功能描述与目标

- 解决的问题: 运维人员需要一个集中的视图来监控适配中心自身各服务模块的健康状况、与各省级视频平台的连接交互状态，以及数据同步任务的整体情况，以便及时发现系统瓶颈或故障。
- 用户价值/目标: 提供对适配中心底层运行状态和数据采集通道健康度的透明化监控，保障数据采集的稳定性和可靠性，支持平台的整体稳定运行。
- 核心能力概述: 持续监控采集与这些平台接口调用的成功率、失败率、平均响应时间、数据同步任务的执行状态、成功同步的数据量及同步延迟等关键交互状态数据 9。
    

#### 4.3.2 原型参考

- 主要原型页面: P_DataColl_Status_Dashboard (采集与系统状态总览仪表盘)

#### 4.3.3 详细需求

##### 4.3.3.1 功能入口与触发条件

- 入口: 运营门户模块 -> 系统监控 / 数据管理 -> 采集与系统状态 [参考原型 P_DataColl_Status_Dashboard]
- 触发条件: 用户已登录，并拥有“采集与系统状态查看”权限。

##### 4.3.3.2 交互流程与界面详述

- **C. 数据采集任务概览 **:
    - 布局: 汇总卡片或小型图表。
    - 展示内容:
        - 当前启用/运行中的数据采集任务总数（来自4.1和4.2）。
        - 今日执行成功/失败的采集任务次数统计。
        - 最近发生错误的采集任务列表摘要。
    - 刷新机制: 定期更新（如每5分钟）。
    - 交互: 点击可跳转至相应的配置列表或日志页面。

##### 4.1.3.3 数据定义 (展示的指标与状态)

数据同步任务执行状态(成功/失败/进行中)、成功同步数据量(条/MB)、数据同步延迟(秒/分钟)。

##### 4.1.3.4 权限控制

- 查看任务状态页面: 需要特定权限，如“采集与系统状态监控”。

#### 4.3.4 业务规则

- 展示的数据应尽可能实时或准实时，以反映当前系统的真实运行状况。
- 本模块主要用于状态展示和快速诊断，详细的日志查询和故障排除可能需要跳转到其他更专业的日志或运维管理模块。
- 指标的正常/警告/危险阈值应可配置（后台配置或系统预设）。

#### 4.3.5 异常处理方案

- 数据获取失败或延迟: 若无法从后端获取最新的状态数据，界面应显示“数据加载中...”或“数据获取失败，请刷新”等提示。
- 部分指标不可用: 若某些指标因依赖的服务未启动或配置问题而无法采集，应在该指标的展示区域明确提示“指标不可用”或“数据源配置错误”。

#### 4.3.6 与其他功能的关联和依赖

- **依赖项 (Dependencies)**:
    - 省级平台连接与交互状态的探测和日志记录组件。
    - （本PRD定义的）运行业务数据采集配置模块和CRM客户数据同步配置模块: 获取这些采集任务的配置信息和执行状态。
    - 接入平台管理模块: 获取已配置的省级平台列表信息。
- **被依赖项 (Generated Dependencies)**:
    - （间接）运维人员和系统管理员: 依赖此模块提供的信息进行日常监控和故障初步判断。
    - （可能）告警管理模块: 本模块监控到的异常状态可能会触发告警。