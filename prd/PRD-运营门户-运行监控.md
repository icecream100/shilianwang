# 需求文档 - 运行监控

## 1. 功能概述

  - 1.1 功能名称：运行监控
  - 1.2 功能概述：运行监控模块为视联网省级适配中心提供实时的状态监测、灵活的告警规则配置以及规范化的告警事件管理能力。它基于适配中心自身健康数据、与省级平台的连接状态数据及关键业务指标数据，通过用户自定义的告警规则，自动生成告警事件，并将告警信息在适配中心内部（如驾驶舱）进行展示。支持告警规则管理和告警事件管理两个核心功能模块。

## 2. 用户与场景

  - 2.1 目标用户: 省级适配中心运维管理员、高级运维人员、系统管理员。
  - 2.2 用户场景/故事:
      - 场景一：作为一个省级适配中心运维管理员，我希望能根据适配中心CPU使用率、接口调用成功率等指标设置告警规则，例如当CPU使用率连续5分钟超过80%时自动产生告警，以便及时发现系统性能瓶颈。
      - 场景二：作为一个省级适配中心高级运维人员，我需要一个界面来查看所有触发的告警事件列表，了解告警的级别、来源、发生时间及详细描述，并能对告警进行管理（如确认、关闭），以便跟踪和处理系统异常。
      - 场景三：作为一个省级适配中心运维管理员，在配置新的省级平台接入后，我希望能快速为其关键的连接状态和数据同步成功率设置监控告警规则，以确保新接入平台的稳定性。

## 3. 功能范围/列表

  - 3.1 功能模块一: 告警规则管理
  - 3.2 功能模块二: 告警事件管理

## 4. 功能模块详情

-----

### 4.1 功能模块：告警规则管理

#### 4.1.1 功能描述与目标

  - 解决问题: 运维人员需要一种灵活的方式来定义何种情况下系统应发出告警，以主动发现潜在或已发生的问题。
  - 用户价值/目标: 允许管理员根据实际运维需求和业务特点，针对各类监控指标自定义告警触发条件，实现精准、有效的自动化监控预警。
  - 核心能力概述: 提供用户界面，允许管理员或高级运维人员基于已采集的适配中心健康数据、省级平台连接状态数据、关键业务指标数据（如视频流请求成功率、接口调用超时次数）等，灵活配置告警触发规则。规则应支持多条件组合（与/或）、比较操作符（大于/小于/等于）、持续时间阈值（如CPU使用率连续5分钟超过80%）等。

#### 4.1.2 原型参考

  - 主要原型页面: 运行监控原型.html - 告警规则管理标签页（包含规则列表、筛选、新增/编辑规则对话框）

#### 4.1.3 详细需求

##### 4.1.3.1 功能入口与触发条件

  - 入口: 运营门户模块 -> 运行监控 -> 告警规则管理 [参考原型 运行监控原型.html - 告警规则管理标签页]
  - 触发条件: 用户已登录，并拥有"告警规则管理"权限。

##### 4.1.3.2 交互流程与界面详述

  - **A. 告警规则列表与查询**: [参考运行监控原型.html - 告警规则管理标签页]
      - 布局: 顶部为"新增规则"按钮和筛选区域，下方为已配置的告警规则列表。
      - 筛选条件: 支持按规则名称、监控对象类型（系统资源、平台连接、业务指标）、告警级别（P0-P3）、启用状态进行筛选，包含重置和查询按钮。
      - 规则列表: 表格形式展示。关键列包括：规则名称（可点击查看详情）、监控对象（带标签显示类型）、告警条件、告警级别（带颜色标识）、状态（启用/停用切换开关）、创建人、创建时间。操作列包含：编辑、删除按钮。
      - 默认交互/排序: 列表默认按创建时间降序，支持分页显示。
  - **B. 新增/编辑告警规则**: [参考运行监控原型.html - 新增/编辑规则对话框]
      - 触发: 点击“新增规则”按钮或已有规则的“编辑”按钮。
      - 交互步骤:
          - Step 1: 进入“告警规则配置”页面/弹窗。
          - Step 2: 输入规则名称（必填，需唯一）。
          - Step 3: 选择监控对象类型（如：适配中心服务、特定省级平台接口、全局业务指标等）。根据选择，动态加载可选的监控指标项。
          - Step 4: 选择监控指标项（如：CPU使用率、接口响应时间、视频流请求成功率等）。
          - Step 5: 配置触发条件：
              - 比较操作符: 大于、小于、等于、大于等于、小于等于、不等于。
              - 阈值: 输入具体的数值。
              - 持续时间阈值: 如“连续N个周期（或N分钟/秒）均满足条件”。
              - (高级) 多条件组合: 允许添加多个条件，并使用“与(AND)”或“或(OR)”逻辑进行组合。每个条件可独立配置指标、操作符和阈值。
          - Step 6: 设置告警级别：选择告警产生时的级别（紧急P0、重要P1、警告P2、提示P3）。
          - Step 7: 配置告警动作 (基础)：
              - 生成告警事件: 默认勾选。
                      - Step 8: 设置规则描述：对规则的详细说明。
          - Step 9: 选择是否立即启用该规则。
          - Step 10: 用户点击“保存”。
          - Step 11: 前后端校验规则配置的完整性和逻辑性（如阈值是否为有效数字、多条件组合是否合理）。
          - Step 12: 成功则保存规则，刷新列表，提示成功；失败则提示错误。
  - **C. 查看规则详情**:
      - 触发: 点击规则列表中的“查看详情”或规则名称。
      - 交互: 展示规则的所有配置信息，只读形式。
  - **D. 启用/停用规则**:
      - 触发: 点击规则列表中的“启用”或“停用”按钮。
      - 交互: 二次确认后，更新规则的启用状态。停用的规则将不再进行条件判断和告警触发。

##### 4.1.3.3 字段定义与数据规则 (告警规则定义)

| 字段名称 | 字段标识 (Eng) | 数据类型 & 长度 | 界面显隐/读写 | 约束/规则                                                                                                   | 数据来源/去向 | 备注/说明 |
|--------------|------------------|-------------------|---------------|--------------------------------------------------------------------|-----------------|----------------------|
| 规则ID | ruleId | Long | 隐藏/只读 | 系统生成                                                                                                    | 系统生成 | 主键 |
| 规则名称 | ruleName | String(100) | 显示/读写 | 必填，唯一                                                                                                   | 用户输入 |  |
| 监控对象类型 | monitorObjectType | Enum | 显示/选择 | 必填                                                                                                      | 用户选择 | 如：SYSTEM\_SERVICE, PLATFORM\_CONNECTION, BUSINESS\_METRIC |
| 监控对象实例 | monitorObjectInstance | String(255) | 显示/选择或输入 | 具体实例，如某服务名、某平台ID                                                                                        | 用户选择/输入 |  |
| 监控指标项 | metricName | String(100) | 显示/选择 | 必填                                                                                                      | 用户选择 | 如：cpuUsage, responseTime, successRate |
| 条件组合逻辑 | conditionLogic | Enum(AND, OR) | 显示/选择 | 若多个条件则必填                                                                                                | 用户选择 |  |
| 触发条件列表 | conditions | List\<Object\> | 通过专用界面配置 | 必填，至少一个条件。每个条件对象包含：指标内操作符（可选，如avg,sum,count）、比较操作符、阈值、持续时间（周期数/秒数）。                                     | 用户配置 |  |
| 告警级别 | alarmLevel | Enum(低, 中, 高, 紧急) | 显示/选择 | 必填                                                                                                      | 用户选择 |  |
| 告警描述模板 | alarmDescriptionTemplate | String(500) | 显示/读写 | 可选，支持变量替换，如 "服务 ${monitorObjectInstance} 的 ${metricName} 当前值为 ${currentValue}, 已超出阈值 ${thresholdValue}" | 用户输入 |  |
| 启用状态 | enabledStatus | Boolean | 显示/切换开关 | 默认为true                                                                                                 | 用户选择 |  |
| 创建人 | createdBy | String(50) | 显示/只读 |                                                                                                         | 系统记录 |  |
| 创建时间 | creationTime | DateTime | 显示/只读 |                                                                                                         | 系统记录 |  |
| 最后修改人 | lastUpdatedBy | String(50) | 显示/只读 |                                                                                                         | 系统记录 |  |
| 最后修改时间 | lastUpdateTime | DateTime | 显示/只读 |                                                                                                         | 系统记录 |  |

##### 4.1.3.4 权限控制

  - 功能访问权限: 拥有"运行监控"模块访问权限的用户可以查看告警规则列表
  - 操作权限: 新增/编辑/删除/启停用告警规则需要"告警规则管理"权限，通常授予管理员或高级运维人员


#### 4.1.4 业务规则

  - 规则的触发条件判断逻辑由监控引擎在后台周期性执行，或者由数据采集模块在数据更新时触发。
  - 持续时间阈值的判断：例如，“CPU使用率连续5分钟超过80%”，意味着在过去的5分钟内，每个数据采集点（或每个检查周期）的CPU使用率都必须大于80%。
  - 规则配置应提供足够的灵活性，以适应不同的监控需求和指标特性。
  - 告警级别应与告警的严重程度和处理优先级对应。

#### 4.1.5 异常处理方案

  - 规则配置逻辑错误: 保存规则时，后端应校验条件组合的有效性、阈值格式等，若不通过则提示用户修改。
  - 选择的监控指标不存在或已失效: 在配置或规则运行时，应有机制处理此类情况，如标记规则无效或产生特定告警。
  - 规则过多导致性能问题: 后端监控引擎在设计时需考虑规则执行效率，避免大量复杂规则影响系统性能。

#### 4.1.6 与其他功能的关联和依赖

  - **依赖项 (Dependencies)**:
      - [cite\_start]业务数据采集与配置管理模块: 提供告警规则所需判断的各类监控数据源（适配中心健康数据、省级平台连接状态数据、关键业务指标数据）。 [cite: 1]
      - （本模块下）告警管理模块: 规则触发后，由告警管理模块负责生成和处理告警事件。
  - **被依赖项 (Generated Dependencies)**:
      - 无。

-----

### 4.2 功能模块：告警事件管理

#### 4.2.1 功能描述与目标

  - 解决问题: 当监控数据满足预设的告警规则时，系统需要自动、实时地生成结构化的告警事件，并提供界面对这些告警进行查看、管理和跟踪处理，同时确保关键告警能被有效传递到相关平台。
  - 用户价值/目标: 实现对系统异常的快速响应和闭环管理，减少故障影响范围和时长，保障系统和业务的连续性。
  - [cite\_start]核心能力概述: 当监控数据满足预设的告警规则时，系统应能自动实时生成结构化的告警事件。告警事件应包含告警级别、告警源、发生时间、告警描述、关联对象（如具体设备或接口）等信息。这些告警事件可推送至适配中心自身的驾驶舱进行实时醒目展示 [cite: 1]，并可按照配置的策略主动上报给标准版平台的统一告警系统，实现告警的集中管理和响应。提供告警列表查看、筛选、排序以及（本地）告警状态管理功能。

#### 4.2.2 原型参考

  - 主要原型页面: 运行监控原型.html - 告警事件管理标签页（包含告警列表、筛选、告警详情对话框）

#### 4.2.3 详细需求

##### 4.2.3.1 功能入口与触发条件

  - 入口: 运营门户模块 -> 运行监控 -> 告警事件管理 [参考原型 运行监控原型.html - 告警事件管理标签页]
  - 触发条件: 用户已登录，并拥有"告警查看"或"告警处理"权限。

##### 4.2.3.2 交互流程与界面详述

  - **A. 告警列表 (活动告警/历史告警)**: [参考运行监控原型.html - 告警事件管理标签页]
      - 布局: 顶部为筛选条件区和操作区（如"批量确认"、"批量关闭"等），下方为告警事件列表。
      - 筛选条件:
          - 告警级别: 多选（紧急P0、重要P1、警告P2、提示P3）。
          - 告警状态: 多选（新告警、已确认、处理中、已解决、已关闭）。
          - 告警源: 输入框，支持模糊匹配。
          - 开始时间/结束时间: 日期时间选择器。
          - 重置和查询按钮。
      - 告警列表: 表格形式展示，支持多选。关键列包括：选择框、告警级别（带颜色标识）、状态（带状态指示器）、告警描述、告警源、发生时间、持续时长、操作（查看详情、确认、解决、关闭等按钮）。
      - 默认交互/排序: 默认按发生时间降序、告警级别降序排列。提供分页。新产生的告警或状态变更的告警应有高亮或实时推送提示（若技术支持）。
  - **B. 查看告警详情**: [参考运行监控原型.html - 告警详情对话框]
      - 触发: 点击告警列表中的告警摘要链接或“查看详情”按钮。
      - 交互: 弹出模态框或跳转新页面，展示告警的全部详细信息：
          - [cite\_start]结构化告警信息: 告警ID、告警规则ID、告警级别、告警源、发生时间、告警描述、关联对象（如具体设备或接口）。 [cite: 1]
          - 触发条件快照: 产生告警时监控指标的实际值、配置的阈值等。
          - （若有）告警处理历史记录：确认人、确认时间、处理备注、解决人、解决时间、关闭人、关闭时间等。
          - （若有）建议处理措施或关联知识库链接。
  - **C. 告警处理 (本地状态管理)**:
      - 触发: 在告警列表操作列或告警详情页点击相应操作按钮（如“确认”、“标记处理中”、“解决”、“关闭”）。
      - 交互:
          - 确认 (Acknowledge): 表示运维人员已注意到此告警。点击后，告警状态变更为“已确认”，记录操作人和时间。
          - 标记处理中 (In Progress, : 表示正在处理此告警。
          - 解决 (Resolve): 表示导致告警的问题已解决。点击后，可要求填写解决说明，告警状态变更为“已解决”。
          - 关闭 (Close): 对已解决或不再关注的告警进行关闭。关闭后通常移至历史告警。
      - 批量操作: 列表支持勾选多个告警进行批量确认或关闭。


##### 4.1.3.3 字段定义与数据规则 (告警事件)

| 字段名称        | 字段标识 (Eng)             | 数据类型 & 长度                                               | 说明                               |
| ----------- | ---------------------- | ------------------------------------------------------- | -------------------------------- |
| 告警事件ID      | alarmEventId           | Long                                                    | 系统生成，唯一                          |
| 触发规则ID      | ruleId                 | Long                                                    | 关联的告警规则ID                        |
| 告警级别        | alarmLevel             | Enum(低, 中, 高, 紧急)                              | 告警的严重程度                          |
| 告警源/监控对象    | alarmSourceOrObject    | String(255)                                             | 产生告警的实体，如服务名、IP、设备ID、接口名         |
| 关联对象类型      | associatedObjectType   | String(100)                                             | （可选）如：SERVICE, DEVICE, INTERFACE |
| 首次发生时间      | firstOccurrenceTime    | DateTime                                                | 告警条件首次满足的时间                      |
| 最近发生时间      | lastOccurrenceTime     | DateTime                                                | 告警条件最近一次满足的时间（用于告警合并或更新）         |
| 恢复时间        | recoveryTime           | DateTime                                                | （可选）若告警已自动恢复，记录恢复时间              |
| 告警描述        | alarmDescription       | Text                                                    | 详细的告警内容，可由规则模板生成                 |
| 当前指标值       | currentMetricValue     | String(100)                                             | （可选）触发告警时指标的实际值                  |
| 阈值          | thresholdValue         | String(100)                                             | （可选）触发告警时规则设定的阈值                 |
| (本地)告警状态    | localStatus            | Enum(新告警, 已确认, 处理中, 已解决, 已关闭) | 适配中心内告警的处理状态                     |
| 确认人         | acknowledgedBy         | String(50)                                              | （可选）                             |
| 确认时间        | acknowledgedTime       | DateTime                                                | （可选）                             |
| 解决人         | resolvedBy             | String(50)                                              | （可选）                             |
| 解决时间        | resolvedTime           | DateTime                                                | （可选）                             |
| 解决备注        | resolutionNotes        | Text                                                    | （可选）                             |

##### 4.1.3.4 权限控制

  - 查看告警列表/详情: 需要具备“告警查看”权限。
  - 处理告警（确认、解决、关闭）: 需要具备“告警处理”权限。


#### 4.2.4 业务规则

  - [cite\_start]告警事件生成: 当监控数据满足已启用的告警规则时，系统自动实时生成结构化的告警事件。 [cite: 1]
    - 告警生命周期管理: 本地告警状态（新告警 -\> 已确认 -\> 已解决 -\> 已关闭）流转应清晰，并记录操作人和时间。
  - 告警数据推送:
      - [cite\_start]告警事件可实时推送到适配中心自身的驾驶舱进行醒目展示。 [cite: 1]
    
  

#### 4.2.5 异常处理方案

  - 告警生成失败: 若因系统内部错误导致告警事件无法正常生成，应记录错误日志，并有备用通知机制（如更高优先级的系统错误告警）。
  - 告警列表加载缓慢或超时: 对于大量告警数据，查询和展示需进行性能优化，如分页加载、索引优化、限制默认查询范围等。


#### 4.2.6 与其他功能的关联和依赖

  - **依赖项 (Dependencies)**:
      - （本模块下）告警规则配置模块: 告警事件的产生依赖于已配置并启用的告警规则。
      - 各数据采集模块 (如业务数据采集、适配中心健康监控等): 提供触发告警规则判断所需的实时监控数据。
      - 驾驶舱模块: 用于实时展示活动告警信息。

  - **被依赖项 (Generated Dependencies)**:
      - 运维工作流程: 产生的告警直接驱动运维人员的故障响应和处理活动。
